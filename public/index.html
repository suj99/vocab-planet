<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è¯æ±‡æ˜Ÿçƒ - æ¯æ—¥è‹±è¯­å­¦ä¹ </title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#a5b4fc;--success:#10b981;--danger:#ef4444;--bg-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--card-bg:rgba(255,255,255,0.95);--text-primary:#1e293b;--text-secondary:#64748b;--shadow:0 8px 30px rgba(0,0,0,0.12);--radius:16px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans SC','Nunito',sans-serif;background:var(--bg-gradient);min-height:100vh;color:var(--text-primary)}
        .container{max-width:480px;margin:0 auto;padding:20px;min-height:100vh}
        .login-container{display:flex;flex-direction:column;justify-content:center;min-height:100vh}
        .card{background:var(--card-bg);border-radius:var(--radius);padding:25px;box-shadow:var(--shadow);margin-bottom:20px}
        .login-card{padding:40px 30px;text-align:center}
        .login-logo{font-size:4rem;margin-bottom:15px}
        .login-title{font-size:1.8rem;font-weight:700;margin-bottom:8px}
        .login-subtitle{color:var(--text-secondary);margin-bottom:30px}
        .input{width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:1rem;margin-bottom:15px}
        .input:focus{outline:none;border-color:var(--primary)}
        .btn{width:100%;padding:14px;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(99,102,241,0.4)}
        .btn-secondary{background:#f1f5f9;color:var(--text-primary)}
        .btn-group{display:flex;gap:12px;margin-top:15px}
        .btn-group .btn{flex:1}
        .divider{display:flex;align-items:center;margin:20px 0;color:var(--text-secondary)}
        .divider::before,.divider::after{content:'';flex:1;height:1px;background:#e2e8f0}
        .divider span{padding:0 15px}
        .user-list{max-height:200px;overflow-y:auto}
        .user-item{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;background:#f8fafc;border-radius:10px;margin-bottom:8px;cursor:pointer}
        .user-item:hover{background:#eef2ff;transform:translateX(5px)}
        .user-info{display:flex;align-items:center;gap:12px}
        .avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
        .avatar-sm{width:28px;height:28px;font-size:0.85rem}
        .user-name{font-weight:600}
        .user-progress{font-size:0.8rem;color:var(--text-secondary)}
        .user-delete{background:none;border:none;color:var(--danger);font-size:1.2rem;cursor:pointer;opacity:0.5}
        .user-delete:hover{opacity:1}
        .no-users{color:var(--text-secondary);padding:20px;text-align:center}
        .header{display:flex;justify-content:space-between;align-items:center;padding:10px 0 20px}
        .logo{display:flex;align-items:center;gap:10px}
        .logo-icon{width:44px;height:44px;background:white;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:var(--shadow)}
        .logo-text{color:white;font-weight:700;font-size:1.3rem}
        .header-right{display:flex;align-items:center;gap:10px}
        .user-badge{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.2);padding:6px 12px 6px 6px;border-radius:25px;color:white;cursor:pointer}
        .settings-btn{width:44px;height:44px;background:rgba(255,255,255,0.2);border:none;border-radius:12px;color:white;font-size:20px;cursor:pointer}
        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:15px}
        .stat-item{text-align:center}
        .stat-value{font-size:1.8rem;font-weight:800;color:var(--primary)}
        .stat-label{font-size:0.8rem;color:var(--text-secondary)}
        .progress-section{padding-top:15px;border-top:1px solid #e2e8f0}
        .progress-header{display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.85rem}
        .progress-bar{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-light));border-radius:4px;transition:width 0.5s}
        .streak-badge{background:linear-gradient(135deg,#f59e0b,#f97316);color:white;padding:4px 12px;border-radius:20px;font-size:0.85rem;font-weight:600;display:inline-flex;align-items:center;gap:4px}
        .nav-tabs{display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:5px}
        .nav-tab{flex-shrink:0;padding:10px 18px;background:rgba(255,255,255,0.2);border:none;border-radius:25px;color:white;font-weight:600;cursor:pointer;transition:all 0.2s}
        .nav-tab.active{background:white;color:var(--primary)}
        .section{display:none}
        .section.active{display:block;animation:fadeIn 0.3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .preview-title{font-size:1.1rem;font-weight:700}
        .preview-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px}
        .preview-word{padding:6px 12px;background:#f1f5f9;border-radius:20px;font-size:0.9rem}
        .preview-word.learned{background:var(--success);color:white}
        .preview-word.current{background:var(--primary);color:white}
        .word-card{text-align:center;position:relative;padding:30px 25px}
        .word-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),#f59e0b)}
        .word-progress{font-size:0.85rem;color:var(--text-secondary);margin-bottom:20px}
        .speak-btn{width:50px;height:50px;background:var(--primary-light);border:none;border-radius:50%;color:var(--primary-dark);font-size:1.4rem;cursor:pointer;margin-bottom:15px}
        .word-english{font-size:2.5rem;font-weight:800;margin-bottom:8px}
        .word-phonetic{font-size:1.1rem;color:var(--primary);margin-bottom:15px}
        .word-chinese{font-size:1.4rem;font-weight:600;margin-bottom:15px}
        .word-category{display:inline-block;padding:4px 12px;background:#f1f5f9;border-radius:15px;font-size:0.8rem;color:var(--text-secondary);margin-bottom:20px}
        .example{background:#f8fafc;border-radius:10px;padding:15px;margin-bottom:10px;text-align:left}
        .example-label{font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
        .example-en{font-size:1rem;margin-bottom:5px;line-height:1.5}
        .example-en .hl{color:var(--primary);font-weight:700}
        .example-cn{font-size:0.9rem;color:var(--text-secondary)}
        .day-selector{margin-bottom:20px}
        .day-selector-title{font-weight:600;margin-bottom:15px}
        .day-btns{display:flex;gap:10px;flex-wrap:wrap}
        .day-btn{padding:10px 16px;background:#f1f5f9;border:2px solid transparent;border-radius:10px;cursor:pointer;font-weight:500}
        .day-btn.active{background:var(--primary);color:white}
        .day-btn:disabled{opacity:0.4;cursor:not-allowed}
        .quiz-header{display:flex;justify-content:space-between;margin-bottom:15px}
        .quiz-type{font-size:0.8rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;font-weight:600}
        .quiz-question{font-size:1.2rem;margin-bottom:20px;line-height:1.6}
        .quiz-question .blank{display:inline-block;min-width:80px;border-bottom:2px dashed var(--primary);margin:0 5px}
        .quiz-hint{color:var(--text-secondary);margin-bottom:15px;font-size:0.9rem}
        .quiz-options{display:flex;flex-direction:column;gap:10px}
        .quiz-option{padding:14px 18px;background:#f8fafc;border:2px solid transparent;border-radius:10px;cursor:pointer;font-size:1rem;text-align:left;transition:all 0.2s}
        .quiz-option:hover{background:#f1f5f9;border-color:var(--primary-light)}
        .quiz-option.correct{border-color:var(--success);background:#ecfdf5}
        .quiz-option.wrong{border-color:var(--danger);background:#fef2f2}
        .quiz-option.disabled{pointer-events:none}
        .result-card{text-align:center;padding:30px}
        .result-icon{font-size:4rem;margin-bottom:15px}
        .result-title{font-size:1.5rem;font-weight:700;margin-bottom:10px}
        .result-score{font-size:3rem;font-weight:800;color:var(--primary);margin-bottom:10px}
        .result-detail{color:var(--text-secondary);margin-bottom:20px}
        .settings-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;opacity:0;visibility:hidden;transition:all 0.3s}
        .settings-overlay.open{opacity:1;visibility:visible}
        .settings-panel{position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100%;background:white;z-index:1000;transition:right 0.3s;overflow-y:auto}
        .settings-panel.open{right:0}
        .settings-header{padding:20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
        .settings-title{font-size:1.2rem;font-weight:700}
        .close-btn{width:36px;height:36px;background:#f1f5f9;border:none;border-radius:50%;font-size:1.2rem;cursor:pointer}
        .settings-content{padding:20px}
        .setting-group{margin-bottom:25px}
        .setting-label{font-weight:600;margin-bottom:10px}
        .slider{width:100%;height:6px;-webkit-appearance:none;background:#e2e8f0;border-radius:3px;outline:none}
        .slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--primary);border-radius:50%;cursor:pointer}
        .slider-value{text-align:center;margin-top:8px;font-weight:600;color:var(--primary)}
        .logout-section{margin-top:30px;padding-top:20px;border-top:1px solid #e2e8f0}
        .logout-btn{width:100%;padding:12px;background:#fef2f2;color:var(--danger);border:none;border-radius:10px;font-weight:600;cursor:pointer}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1001;opacity:0;visibility:hidden;transition:all 0.3s;padding:20px}
        .modal.show{opacity:1;visibility:visible}
        .modal-content{background:white;border-radius:var(--radius);padding:40px 30px;text-align:center;max-width:340px;transform:scale(0.8);transition:transform 0.3s}
        .modal.show .modal-content{transform:scale(1)}
        .modal-icon{font-size:4rem;margin-bottom:20px}
        .modal-title{font-size:1.5rem;font-weight:700;margin-bottom:10px}
        .modal-msg{color:var(--text-secondary);margin-bottom:25px}
        .loading{text-align:center;padding:40px;color:var(--text-secondary)}
        .loading-spinner{width:40px;height:40px;border:4px solid #e2e8f0;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .hidden{display:none!important}
        .app-container{display:none}
        .app-container.active{display:block}
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="container login-container" id="loginPage">
        <div class="card login-card">
            <div class="login-logo">ğŸ“š</div>
            <div class="login-title">è¯æ±‡æ˜Ÿçƒ</div>
            <div class="login-subtitle">æŒæ¡1000ä¸ªæœ€å¸¸ç”¨è‹±è¯­å•è¯</div>
            <input type="text" class="input" id="usernameInput" placeholder="è¾“å…¥ä½ çš„åå­—" maxlength="10">
            <button class="btn btn-primary" onclick="createUser()">å¼€å§‹å­¦ä¹ </button>
            <div class="divider"><span>æˆ–é€‰æ‹©å·²æœ‰è´¦æˆ·</span></div>
            <div class="user-list" id="userList"></div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div class="container app-container" id="appPage">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ“š</div>
                <span class="logo-text">è¯æ±‡æ˜Ÿçƒ</span>
            </div>
            <div class="header-right">
                <div class="user-badge" onclick="toggleSettings()">
                    <div class="avatar avatar-sm" id="headerAvatar">T</div>
                    <span id="headerName">Tom</span>
                </div>
                <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
            </div>
        </header>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <span style="color:var(--text-secondary)">å­¦ä¹ è¿›åº¦</span>
                <div class="streak-badge">ğŸ”¥ <span id="streakDays">0</span>å¤©</div>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="learnedCount">0</div>
                    <div class="stat-label">å·²å­¦å•è¯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="masteredCount">0</div>
                    <div class="stat-label">å·²æŒæ¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">ä»Šæ—¥å­¦ä¹ </div>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-header">
                    <span>æ€»ä½“è¿›åº¦</span>
                    <span><span id="progressPct">0</span>%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width:0%"></div>
                </div>
            </div>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="learn" onclick="switchTab('learn')">ğŸ“– ä»Šæ—¥å­¦ä¹ </button>
            <button class="nav-tab" data-tab="practice" onclick="switchTab('practice')">âœï¸ ç»ƒä¹ </button>
            <button class="nav-tab" data-tab="test" onclick="switchTab('test')">ğŸ“ æµ‹éªŒ</button>
        </div>

        <!-- å­¦ä¹ åŒºåŸŸ -->
        <div class="section active" id="section-learn">
            <div class="card" id="previewCard">
                <div class="preview-header">
                    <span class="preview-title">ğŸ“‹ ä»Šæ—¥è¯æ±‡</span>
                    <span id="previewCount">0/15</span>
                </div>
                <div class="preview-list" id="previewList"></div>
                <button class="btn btn-primary" id="startBtn" onclick="startLearning()">å¼€å§‹å­¦ä¹ </button>
            </div>
            <div class="card word-card hidden" id="wordCard">
                <div class="word-progress">ç¬¬ <span id="wordIdx">1</span> / <span id="wordTotal">15</span> ä¸ª</div>
                <button class="speak-btn" onclick="speakWord()">ğŸ”Š</button>
                <div class="word-english" id="wordEn">hello</div>
                <div class="word-phonetic" id="wordPh">/hÉ™ËˆloÊŠ/</div>
                <div class="word-chinese" id="wordCn">ä½ å¥½</div>
                <div class="word-category" id="wordCat">é—®å€™</div>
                <div id="examplesBox"></div>
            </div>
            <div class="btn-group hidden" id="learnBtns">
                <button class="btn btn-secondary" onclick="markWord(false)">ğŸ˜° ä¸ç†Ÿ</button>
                <button class="btn btn-primary" onclick="markWord(true)">ğŸ˜Š ä¸‹ä¸€ä¸ª</button>
            </div>
        </div>

        <!-- ç»ƒä¹ åŒºåŸŸ -->
        <div class="section" id="section-practice">
            <div class="card day-selector">
                <div class="day-selector-title">é€‰æ‹©ç»ƒä¹ èŒƒå›´</div>
                <div class="day-btns" id="practiceDayBtns"></div>
            </div>
            <div id="practiceArea"></div>
        </div>

        <!-- æµ‹éªŒåŒºåŸŸ -->
        <div class="section" id="section-test">
            <div class="card day-selector">
                <div class="day-selector-title">é€‰æ‹©æµ‹éªŒèŒƒå›´</div>
                <div class="day-btns" id="testDayBtns"></div>
            </div>
            <div id="testArea"></div>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span class="settings-title">âš™ï¸ è®¾ç½®</span>
            <button class="close-btn" onclick="toggleSettings()">âœ•</button>
        </div>
        <div class="settings-content">
            <div class="setting-group">
                <div class="setting-label">ğŸ‘¤ å½“å‰ç”¨æˆ·</div>
                <div id="settingsUserName" style="color:var(--primary);font-weight:600"></div>
            </div>
            <div class="setting-group">
                <div class="setting-label">ğŸ“ æ¯æ—¥å•è¯æ•°</div>
                <input type="range" class="slider" id="dailySlider" min="5" max="30" value="15" oninput="updateSliderValue()">
                <div class="slider-value"><span id="dailyValue">15</span> ä¸ª/å¤©</div>
            </div>
            <div class="setting-group">
                <div class="setting-label">ğŸ”Š å‘éŸ³å£éŸ³</div>
                <select class="input" id="accentSelect">
                    <option value="us">ç¾å¼å‘éŸ³</option>
                    <option value="uk">è‹±å¼å‘éŸ³</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
            <div class="logout-section">
                <button class="logout-btn" onclick="logout()">ğŸšª åˆ‡æ¢ç”¨æˆ·</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">ğŸ‰</div>
            <div class="modal-title" id="modalTitle">å®Œæˆï¼</div>
            <div class="modal-msg" id="modalMsg"></div>
            <button class="btn btn-primary" onclick="closeModal()">ç¡®å®š</button>
        </div>
    </div>

<script>
// ===== å…¨å±€å˜é‡ =====
let vocab = [];
let allUsers = {};
let currentUser = null;
let state = {
    todayWords: [],
    wordIdx: 0,
    isLearning: false,
    practiceDays: 1,
    testDays: 1,
    practiceWords: [],
    practiceIdx: 0,
    testWords: [],
    testIdx: 0,
    testResults: []
};

// ===== åˆå§‹åŒ– =====
async function init() {
    await loadVocabulary();
    loadUsers();
    const saved = localStorage.getItem('vp_current');
    if (saved && allUsers[saved]) {
        login(saved);
    }
}

async function loadVocabulary() {
    try {
        const res = await fetch('data/words.json');
        vocab = await res.json();
        console.log(`è¯åº“åŠ è½½æˆåŠŸ: ${vocab.length} ä¸ªå•è¯`);
    } catch (e) {
        console.error('è¯åº“åŠ è½½å¤±è´¥', e);
        vocab = [];
    }
}

// ===== ç”¨æˆ·ç®¡ç† =====
function loadUsers() {
    const data = localStorage.getItem('vp_users');
    if (data) allUsers = JSON.parse(data);
    renderUserList();
}

function saveUsers() {
    localStorage.setItem('vp_users', JSON.stringify(allUsers));
}

function renderUserList() {
    const list = document.getElementById('userList');
    const names = Object.keys(allUsers);
    if (!names.length) {
        list.innerHTML = '<div class="no-users">è¿˜æ²¡æœ‰ç”¨æˆ·ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>';
        return;
    }
    list.innerHTML = names.map(n => {
        const u = allUsers[n];
        return `<div class="user-item" onclick="login('${n}')">
            <div class="user-info">
                <div class="avatar">${n[0].toUpperCase()}</div>
                <div>
                    <div class="user-name">${n}</div>
                    <div class="user-progress">å·²å­¦${u.learned.length} Â· å·²æŒæ¡${u.mastered.length}</div>
                </div>
            </div>
            <button class="user-delete" onclick="event.stopPropagation();deleteUser('${n}')">Ã—</button>
        </div>`;
    }).join('');
}

function createUser() {
    const name = document.getElementById('usernameInput').value.trim();
    if (!name) return alert('è¯·è¾“å…¥åå­—');
    if (!allUsers[name]) {
        allUsers[name] = {
            name,
            learned: [],
            mastered: [],
            streak: 0,
            lastDate: null,
            history: [],
            settings: { daily: 15, accent: 'us' }
        };
    }
    saveUsers();
    login(name);
}

function deleteUser(name) {
    if (confirm(`ç¡®å®šåˆ é™¤ "${name}"ï¼Ÿ`)) {
        delete allUsers[name];
        saveUsers();
        renderUserList();
    }
}

function login(name) {
    currentUser = name;
    localStorage.setItem('vp_current', name);
    checkStreak();
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appPage').classList.add('active');
    document.getElementById('headerAvatar').textContent = name[0].toUpperCase();
    document.getElementById('headerName').textContent = name;
    document.getElementById('settingsUserName').textContent = name;
    prepareToday();
    updateStats();
    renderDayButtons();
}

function logout() {
    currentUser = null;
    localStorage.removeItem('vp_current');
    document.getElementById('appPage').classList.remove('active');
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('usernameInput').value = '';
    toggleSettings();
    renderUserList();
}

function checkStreak() {
    const u = allUsers[currentUser];
    const today = new Date().toDateString();
    if (u.lastDate) {
        const last = new Date(u.lastDate).toDateString();
        if (last !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            u.streak = (last === yesterday.toDateString()) ? u.streak + 1 : 1;
        }
    } else {
        u.streak = 1;
    }
    u.lastDate = new Date().toISOString();
    saveUsers();
}

// ===== ä»Šæ—¥å­¦ä¹  =====
function prepareToday() {
    const u = allUsers[currentUser];
    const today = new Date().toDateString();
    let record = u.history.find(h => new Date(h.date).toDateString() === today);
    
    if (!record) {
        // æŒ‰é¢‘ç‡é¡ºåºè·å–æœªå­¦å•è¯
        const unlearned = vocab.filter(w => !u.learned.includes(w.word));
        const todayWords = unlearned.slice(0, u.settings.daily).map(w => w.word);
        record = { date: new Date().toISOString(), words: todayWords, done: [] };
        u.history.push(record);
        saveUsers();
    }
    
    state.todayWords = record.words.map(w => vocab.find(v => v.word === w)).filter(Boolean);
    state.wordIdx = record.done.length;
    state.isLearning = false;
    renderPreview();
}

function renderPreview() {
    const u = allUsers[currentUser];
    const today = new Date().toDateString();
    const record = u.history.find(h => new Date(h.date).toDateString() === today);
    const done = record ? record.done : [];
    
    document.getElementById('previewList').innerHTML = state.todayWords.map((w, i) => {
        const isDone = done.includes(w.word);
        const isCurrent = i === state.wordIdx && state.isLearning;
        return `<span class="preview-word ${isDone ? 'learned' : ''} ${isCurrent ? 'current' : ''}">${w.word}</span>`;
    }).join('');
    
    document.getElementById('previewCount').textContent = `${done.length}/${state.todayWords.length}`;
    
    const btn = document.getElementById('startBtn');
    const allDone = done.length >= state.todayWords.length;
    btn.textContent = allDone ? 'âœ… ä»Šæ—¥å·²å®Œæˆ' : (state.wordIdx > 0 ? 'ç»§ç»­å­¦ä¹ ' : 'å¼€å§‹å­¦ä¹ ');
    btn.disabled = allDone || state.todayWords.length === 0;
    btn.style.opacity = (allDone || state.todayWords.length === 0) ? '0.6' : '1';
}

function startLearning() {
    if (state.todayWords.length === 0) return;
    state.isLearning = true;
    document.getElementById('previewCard').classList.add('hidden');
    document.getElementById('wordCard').classList.remove('hidden');
    document.getElementById('learnBtns').classList.remove('hidden');
    document.getElementById('wordTotal').textContent = state.todayWords.length;
    showWord();
}

function showWord() {
    if (state.wordIdx >= state.todayWords.length) {
        finishLearning();
        return;
    }
    const w = state.todayWords[state.wordIdx];
    document.getElementById('wordIdx').textContent = state.wordIdx + 1;
    document.getElementById('wordEn').textContent = w.word;
    document.getElementById('wordPh').textContent = w.phonetic;
    document.getElementById('wordCn').textContent = w.chinese;
    document.getElementById('wordCat').textContent = w.category;
    
    const exBox = document.getElementById('examplesBox');
    exBox.innerHTML = w.examples.map((ex, i) => `
        <div class="example">
            <div class="example-label">ä¾‹å¥${i + 1}</div>
            <div class="example-en">${ex.en.replace(new RegExp(`(${w.word})`, 'gi'), '<span class="hl">$1</span>')}</div>
            <div class="example-cn">${ex.cn}</div>
        </div>
    `).join('');
    
    renderPreview();
}

function markWord(known) {
    const u = allUsers[currentUser];
    const w = state.todayWords[state.wordIdx];
    const today = new Date().toDateString();
    
    if (!u.learned.includes(w.word)) {
        u.learned.push(w.word);
    }
    
    const record = u.history.find(h => new Date(h.date).toDateString() === today);
    if (record && !record.done.includes(w.word)) {
        record.done.push(w.word);
    }
    
    state.wordIdx++;
    saveUsers();
    updateStats();
    showWord();
}

function finishLearning() {
    state.isLearning = false;
    document.getElementById('wordCard').classList.add('hidden');
    document.getElementById('learnBtns').classList.add('hidden');
    document.getElementById('previewCard').classList.remove('hidden');
    renderPreview();
    showModal('ğŸ‰', 'å­¦ä¹ å®Œæˆï¼', 'å»ç»ƒä¹ å·©å›ºä¸€ä¸‹å§ï¼');
}

function speakWord() {
    if (state.wordIdx >= state.todayWords.length) return;
    const w = state.todayWords[state.wordIdx];
    const u = allUsers[currentUser];
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(w.word);
        utterance.lang = u.settings.accent === 'uk' ? 'en-GB' : 'en-US';
        utterance.rate = 0.8;
        speechSynthesis.speak(utterance);
    }
}

// ===== ç»Ÿè®¡æ›´æ–° =====
function updateStats() {
    const u = allUsers[currentUser];
    const today = new Date().toDateString();
    const record = u.history.find(h => new Date(h.date).toDateString() === today);
    
    document.getElementById('streakDays').textContent = u.streak;
    document.getElementById('learnedCount').textContent = u.learned.length;
    document.getElementById('masteredCount').textContent = u.mastered.length;
    document.getElementById('todayCount').textContent = record ? record.done.length : 0;
    
    const pct = vocab.length > 0 ? ((u.learned.length / vocab.length) * 100).toFixed(1) : 0;
    document.getElementById('progressPct').textContent = pct;
    document.getElementById('progressBar').style.width = pct + '%';
}

// ===== ç»ƒä¹ å’Œæµ‹éªŒ =====
function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + tab).classList.add('active');
    
    if (tab === 'practice') initPractice();
    if (tab === 'test') initTest();
}

function renderDayButtons() {
    const u = allUsers[currentUser];
    const availDays = Math.min(5, u.history.length);
    
    ['practice', 'test'].forEach(type => {
        const container = document.getElementById(type + 'DayBtns');
        let html = '';
        for (let i = 1; i <= 5; i++) {
            const active = (type === 'practice' ? state.practiceDays : state.testDays) === i;
            const disabled = i > availDays;
            html += `<button class="day-btn ${active ? 'active' : ''}" ${disabled ? 'disabled' : ''} onclick="selectDays('${type}', ${i})">${i}å¤©</button>`;
        }
        container.innerHTML = html;
    });
}

function selectDays(type, days) {
    if (type === 'practice') {
        state.practiceDays = days;
        initPractice();
    } else {
        state.testDays = days;
        initTest();
    }
    renderDayButtons();
}

function getWordsForDays(days) {
    const u = allUsers[currentUser];
    const recent = u.history.slice(-days);
    const wordSet = new Set();
    recent.forEach(h => h.done.forEach(w => wordSet.add(w)));
    return Array.from(wordSet).map(w => vocab.find(v => v.word === w)).filter(Boolean);
}

function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function generateOptions(correct, count = 4) {
    const others = vocab.filter(w => w.word !== correct).map(w => w.word);
    const shuffled = shuffle(others).slice(0, count - 1);
    return shuffle([correct, ...shuffled]);
}

// ç»ƒä¹ 
function initPractice() {
    const words = getWordsForDays(state.practiceDays);
    const area = document.getElementById('practiceArea');
    
    if (!words.length) {
        area.innerHTML = '<div class="card"><div class="loading">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•ï¼Œå…ˆå»å­¦ä¹ å§ï¼</div></div>';
        return;
    }
    
    state.practiceWords = shuffle(words);
    state.practiceIdx = 0;
    showPracticeQuestion();
}

function showPracticeQuestion() {
    const area = document.getElementById('practiceArea');
    
    if (state.practiceIdx >= state.practiceWords.length) {
        state.practiceIdx = 0;
        state.practiceWords = shuffle(state.practiceWords);
    }
    
    const w = state.practiceWords[state.practiceIdx];
    const ex = w.examples[Math.floor(Math.random() * w.examples.length)];
    const sentence = ex.en.replace(new RegExp(`\\b${w.word}\\b`, 'gi'), '___');
    const options = generateOptions(w.word);
    
    area.innerHTML = `
        <div class="card">
            <div class="quiz-header">
                <span class="quiz-type">å¡«ç©ºç»ƒä¹ </span>
                <span>${state.practiceIdx + 1} / ${state.practiceWords.length}</span>
            </div>
            <div class="quiz-question">${sentence.replace('___', '<span class="blank"></span>')}</div>
            <div class="quiz-hint">æç¤ºï¼š${w.chinese}</div>
            <div class="quiz-options">
                ${options.map(o => `<button class="quiz-option" onclick="checkPractice(this, '${o}', '${w.word}')">${o}</button>`).join('')}
            </div>
        </div>
    `;
}

function checkPractice(btn, selected, correct) {
    const options = document.querySelectorAll('#practiceArea .quiz-option');
    options.forEach(o => {
        o.classList.add('disabled');
        if (o.textContent === correct) o.classList.add('correct');
        else if (o === btn && selected !== correct) o.classList.add('wrong');
    });
    
    setTimeout(() => {
        state.practiceIdx++;
        showPracticeQuestion();
    }, 1000);
}

// æµ‹éªŒ
function initTest() {
    const words = getWordsForDays(state.testDays);
    const area = document.getElementById('testArea');
    
    if (!words.length) {
        area.innerHTML = '<div class="card"><div class="loading">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•ï¼Œå…ˆå»å­¦ä¹ å§ï¼</div></div>';
        return;
    }
    
    area.innerHTML = `
        <div class="card" style="text-align:center">
            <p style="font-size:1.1rem;margin-bottom:15px">æµ‹éªŒåŒ…å« <strong>${words.length}</strong> ä¸ªå•è¯</p>
            <p style="color:var(--text-secondary);margin-bottom:20px">ç­”å¯¹çš„å•è¯å°†æ ‡è®°ä¸º"å·²æŒæ¡"</p>
            <button class="btn btn-primary" onclick="startTest()">å¼€å§‹æµ‹éªŒ</button>
        </div>
    `;
}

function startTest() {
    const words = getWordsForDays(state.testDays);
    state.testWords = shuffle(words);
    state.testIdx = 0;
    state.testResults = [];
    showTestQuestion();
}

function showTestQuestion() {
    const area = document.getElementById('testArea');
    
    if (state.testIdx >= state.testWords.length) {
        showTestResults();
        return;
    }
    
    const w = state.testWords[state.testIdx];
    const ex = w.examples[Math.floor(Math.random() * w.examples.length)];
    const sentence = ex.en.replace(new RegExp(`\\b${w.word}\\b`, 'gi'), '___');
    const options = generateOptions(w.word);
    
    area.innerHTML = `
        <div class="card">
            <div class="quiz-header">
                <span class="quiz-type">ğŸ“ æµ‹éªŒ</span>
                <span>${state.testIdx + 1} / ${state.testWords.length}</span>
            </div>
            <div class="quiz-question">${sentence.replace('___', '<span class="blank"></span>')}</div>
            <div class="quiz-hint">æç¤ºï¼š${w.chinese}</div>
            <div class="quiz-options">
                ${options.map(o => `<button class="quiz-option" onclick="checkTest(this, '${o}', '${w.word}')">${o}</button>`).join('')}
            </div>
        </div>
    `;
}

function checkTest(btn, selected, correct) {
    const isCorrect = selected === correct;
    state.testResults.push({ word: correct, correct: isCorrect });
    
    if (isCorrect) {
        const u = allUsers[currentUser];
        if (!u.mastered.includes(correct)) {
            u.mastered.push(correct);
            saveUsers();
        }
    }
    
    const options = document.querySelectorAll('#testArea .quiz-option');
    options.forEach(o => {
        o.classList.add('disabled');
        if (o.textContent === correct) o.classList.add('correct');
        else if (o === btn && !isCorrect) o.classList.add('wrong');
    });
    
    setTimeout(() => {
        state.testIdx++;
        updateStats();
        showTestQuestion();
    }, 1000);
}

function showTestResults() {
    const area = document.getElementById('testArea');
    const correctCount = state.testResults.filter(r => r.correct).length;
    const total = state.testResults.length;
    const pct = Math.round((correctCount / total) * 100);
    
    area.innerHTML = `
        <div class="card result-card">
            <div class="result-icon">${pct >= 60 ? 'ğŸ‰' : 'ğŸ˜¢'}</div>
            <div class="result-title">${pct >= 60 ? 'æµ‹éªŒé€šè¿‡ï¼' : 'ç»§ç»­åŠ æ²¹ï¼'}</div>
            <div class="result-score">${pct}%</div>
            <div class="result-detail">${correctCount} / ${total} æ­£ç¡®</div>
            <button class="btn btn-primary" onclick="initTest()">å†æµ‹ä¸€æ¬¡</button>
        </div>
    `;
}

// ===== è®¾ç½® =====
function toggleSettings() {
    document.getElementById('settingsOverlay').classList.toggle('open');
    document.getElementById('settingsPanel').classList.toggle('open');
    
    if (currentUser) {
        const u = allUsers[currentUser];
        document.getElementById('dailySlider').value = u.settings.daily;
        document.getElementById('dailyValue').textContent = u.settings.daily;
        document.getElementById('accentSelect').value = u.settings.accent;
    }
}

function updateSliderValue() {
    document.getElementById('dailyValue').textContent = document.getElementById('dailySlider').value;
}

function saveSettings() {
    const u = allUsers[currentUser];
    u.settings.daily = parseInt(document.getElementById('dailySlider').value);
    u.settings.accent = document.getElementById('accentSelect').value;
    saveUsers();
    toggleSettings();
    showModal('âœ…', 'è®¾ç½®å·²ä¿å­˜', '');
}

// ===== å¼¹çª— =====
function showModal(icon, title, msg) {
    document.getElementById('modalIcon').textContent = icon;
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMsg').textContent = msg;
    document.getElementById('modal').classList.add('show');
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

// å¯åŠ¨åº”ç”¨
init();
</script>
</body>
</html>
