<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è¯æ±‡æ˜Ÿçƒ - æ¯æ—¥è‹±è¯­å­¦ä¹ </title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#a5b4fc;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--bg-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--card-bg:rgba(255,255,255,0.95);--text-primary:#1e293b;--text-secondary:#64748b;--shadow:0 8px 30px rgba(0,0,0,0.12);--radius:16px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans SC','Nunito',sans-serif;background:var(--bg-gradient);min-height:100vh;color:var(--text-primary)}
        .container{max-width:480px;margin:0 auto;padding:20px;min-height:100vh}
        .login-container{display:flex;flex-direction:column;justify-content:center;min-height:100vh}
        .card{background:var(--card-bg);border-radius:var(--radius);padding:25px;box-shadow:var(--shadow);margin-bottom:20px}
        .login-card{padding:40px 30px;text-align:center}
        .login-logo{font-size:4rem;margin-bottom:15px}
        .login-title{font-size:1.8rem;font-weight:700;margin-bottom:8px}
        .login-subtitle{color:var(--text-secondary);margin-bottom:30px}
        .input{width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:1rem;margin-bottom:15px}
        .input:focus{outline:none;border-color:var(--primary)}
        .btn{width:100%;padding:14px;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(99,102,241,0.4)}
        .btn-secondary{background:#f1f5f9;color:var(--text-primary)}
        .btn-success{background:linear-gradient(135deg,var(--success),#059669);color:white}
        .btn-warning{background:linear-gradient(135deg,var(--warning),#d97706);color:white}
        .btn-group{display:flex;gap:12px;margin-top:15px}
        .btn-group .btn{flex:1}
        .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
        .divider{display:flex;align-items:center;margin:20px 0;color:var(--text-secondary)}
        .divider::before,.divider::after{content:'';flex:1;height:1px;background:#e2e8f0}
        .divider span{padding:0 15px}
        .user-list{max-height:200px;overflow-y:auto}
        .user-item{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;background:#f8fafc;border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
        .user-item:hover{background:#eef2ff;transform:translateX(5px)}
        .user-info{display:flex;align-items:center;gap:12px}
        .avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
        .avatar-sm{width:28px;height:28px;font-size:0.85rem}
        .user-name{font-weight:600}
        .user-progress{font-size:0.8rem;color:var(--text-secondary)}
        .user-delete{background:none;border:none;color:var(--danger);font-size:1.2rem;cursor:pointer;opacity:0.5}
        .user-delete:hover{opacity:1}
        .no-users{color:var(--text-secondary);padding:20px;text-align:center}
        .header{display:flex;justify-content:space-between;align-items:center;padding:10px 0 20px}
        .logo{display:flex;align-items:center;gap:10px}
        .logo-icon{width:44px;height:44px;background:white;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:var(--shadow)}
        .logo-text{color:white;font-weight:700;font-size:1.3rem}
        .header-right{display:flex;align-items:center;gap:10px}
        .user-badge{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.2);padding:6px 12px 6px 6px;border-radius:25px;color:white;cursor:pointer}
        .settings-btn{width:44px;height:44px;background:rgba(255,255,255,0.2);border:none;border-radius:12px;color:white;font-size:20px;cursor:pointer}
        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:15px}
        .stat-item{text-align:center}
        .stat-value{font-size:1.8rem;font-weight:800;color:var(--primary)}
        .stat-label{font-size:0.8rem;color:var(--text-secondary)}
        .progress-section{padding-top:15px;border-top:1px solid #e2e8f0}
        .progress-header{display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.85rem}
        .progress-bar{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-light));border-radius:4px;transition:width 0.5s}
        .streak-badge{background:linear-gradient(135deg,#f59e0b,#f97316);color:white;padding:4px 12px;border-radius:20px;font-size:0.85rem;font-weight:600;display:inline-flex;align-items:center;gap:4px}
        .nav-tabs{display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:5px}
        .nav-tab{flex-shrink:0;padding:10px 18px;background:rgba(255,255,255,0.2);border:none;border-radius:25px;color:white;font-weight:600;cursor:pointer;transition:all 0.2s}
        .nav-tab.active{background:white;color:var(--primary)}
        .section{display:none}
        .section.active{display:block;animation:fadeIn 0.3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .lesson-selector{margin-bottom:20px}
        .lesson-selector-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .lesson-selector-title{font-size:1.1rem;font-weight:700}
        .lesson-nav{display:flex;gap:8px}
        .lesson-nav-btn{width:36px;height:36px;background:#f1f5f9;border:none;border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .lesson-nav-btn:hover{background:#e2e8f0}
        .lesson-nav-btn:disabled{opacity:0.3;cursor:not-allowed}
        .lesson-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
        .lesson-item{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafc;border:2px solid transparent;border-radius:12px;cursor:pointer;transition:all 0.2s;position:relative}
        .lesson-item:hover{background:#f1f5f9;transform:translateY(-2px)}
        .lesson-item.current{border-color:var(--primary);background:#eef2ff}
        .lesson-item.completed{background:#ecfdf5;border-color:var(--success)}
        .lesson-item.selected{box-shadow:0 0 0 3px var(--primary)}
        .lesson-num{font-size:1.2rem;font-weight:700;color:var(--text-primary)}
        .lesson-item.completed .lesson-num{color:var(--success)}
        .lesson-item.current .lesson-num{color:var(--primary)}
        .lesson-status{font-size:0.65rem;color:var(--text-secondary);margin-top:2px}
        .lesson-item.completed .lesson-status{color:var(--success)}
        .lesson-check{position:absolute;top:4px;right:4px;font-size:0.8rem}
        .lesson-info{text-align:center;padding:15px;background:#f8fafc;border-radius:10px;margin-top:15px}
        .lesson-info-title{font-weight:600;margin-bottom:5px}
        .lesson-info-detail{font-size:0.85rem;color:var(--text-secondary)}
        .lesson-words-preview{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;justify-content:center}
        .lesson-word-tag{padding:4px 10px;background:white;border-radius:15px;font-size:0.8rem;border:1px solid #e2e8f0}
        .preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .preview-title{font-size:1.1rem;font-weight:700}
        .preview-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px}
        .preview-word{padding:6px 12px;background:#f1f5f9;border-radius:20px;font-size:0.9rem}
        .preview-word.learned{background:var(--success);color:white}
        .preview-word.current{background:var(--primary);color:white}
        .word-card{text-align:center;position:relative;padding:30px 25px}
        .word-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),#f59e0b)}
        .word-progress{font-size:0.85rem;color:var(--text-secondary);margin-bottom:20px}
        .speak-btn{width:50px;height:50px;background:var(--primary-light);border:none;border-radius:50%;color:var(--primary-dark);font-size:1.4rem;cursor:pointer;margin-bottom:15px}
        .word-english{font-size:2.5rem;font-weight:800;margin-bottom:8px}
        .word-phonetic{font-size:1.1rem;color:var(--primary);margin-bottom:15px}
        .word-chinese{font-size:1.4rem;font-weight:600;margin-bottom:15px}
        .word-category{display:inline-block;padding:4px 12px;background:#f1f5f9;border-radius:15px;font-size:0.8rem;color:var(--text-secondary);margin-bottom:20px}
        .example{background:#f8fafc;border-radius:10px;padding:15px;margin-bottom:10px;text-align:left}
        .example-label{font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
        .example-en{font-size:1rem;margin-bottom:5px;line-height:1.5}
        .example-en .hl{color:var(--primary);font-weight:700}
        .example-cn{font-size:0.9rem;color:var(--text-secondary)}
        .day-selector{margin-bottom:20px}
        .day-selector-title{font-weight:600;margin-bottom:15px}
        .day-btns{display:flex;gap:10px;flex-wrap:wrap}
        .day-btn{padding:10px 16px;background:#f1f5f9;border:2px solid transparent;border-radius:10px;cursor:pointer;font-weight:500}
        .day-btn.active{background:var(--primary);color:white}
        .day-btn:disabled{opacity:0.4;cursor:not-allowed}
        .quiz-header{display:flex;justify-content:space-between;margin-bottom:15px}
        .quiz-type{font-size:0.8rem;color:var(--primary);text-transform:uppercase;letter-spacing:1px;font-weight:600}
        .quiz-question{font-size:1.2rem;margin-bottom:20px;line-height:1.6}
        .quiz-question .blank{display:inline-block;min-width:80px;border-bottom:2px dashed var(--primary);margin:0 5px}
        .quiz-hint{color:var(--text-secondary);margin-bottom:15px;font-size:0.9rem}
        .quiz-options{display:flex;flex-direction:column;gap:10px}
        .quiz-option{padding:14px 18px;background:#f8fafc;border:2px solid transparent;border-radius:10px;cursor:pointer;font-size:1rem;text-align:left;transition:all 0.2s}
        .quiz-option:hover{background:#f1f5f9;border-color:var(--primary-light)}
        .quiz-option.correct{border-color:var(--success);background:#ecfdf5}
        .quiz-option.wrong{border-color:var(--danger);background:#fef2f2}
        .quiz-option.disabled{pointer-events:none}
        .result-card{text-align:center;padding:30px}
        .result-icon{font-size:4rem;margin-bottom:15px}
        .result-title{font-size:1.5rem;font-weight:700;margin-bottom:10px}
        .result-score{font-size:3rem;font-weight:800;color:var(--primary);margin-bottom:10px}
        .result-detail{color:var(--text-secondary);margin-bottom:20px}
        .settings-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;opacity:0;visibility:hidden;transition:all 0.3s}
        .settings-overlay.open{opacity:1;visibility:visible}
        .settings-panel{position:fixed;top:0;right:-100%;width:100%;max-width:400px;height:100%;background:white;z-index:1000;transition:right 0.3s;overflow-y:auto}
        .settings-panel.open{right:0}
        .settings-header{padding:20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
        .settings-title{font-size:1.2rem;font-weight:700}
        .close-btn{width:36px;height:36px;background:#f1f5f9;border:none;border-radius:50%;font-size:1.2rem;cursor:pointer}
        .settings-content{padding:20px}
        .setting-group{margin-bottom:25px}
        .setting-label{font-weight:600;margin-bottom:10px}
        .slider{width:100%;height:6px;-webkit-appearance:none;background:#e2e8f0;border-radius:3px;outline:none}
        .slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:var(--primary);border-radius:50%;cursor:pointer}
        .slider-value{text-align:center;margin-top:8px;font-weight:600;color:var(--primary)}
        .logout-section{margin-top:30px;padding-top:20px;border-top:1px solid #e2e8f0}
        .logout-btn{width:100%;padding:12px;background:#fef2f2;color:var(--danger);border:none;border-radius:10px;font-weight:600;cursor:pointer}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1001;opacity:0;visibility:hidden;transition:all 0.3s;padding:20px}
        .modal.show{opacity:1;visibility:visible}
        .modal-content{background:white;border-radius:var(--radius);padding:40px 30px;text-align:center;max-width:340px;transform:scale(0.8);transition:transform 0.3s}
        .modal.show .modal-content{transform:scale(1)}
        .modal-icon{font-size:4rem;margin-bottom:20px}
        .modal-title{font-size:1.5rem;font-weight:700;margin-bottom:10px}
        .modal-msg{color:var(--text-secondary);margin-bottom:25px}
        .hidden{display:none!important}
        .app-container{display:none}
        .app-container.active{display:block}
        .back-btn{display:inline-flex;align-items:center;gap:5px;padding:8px 15px;background:#f1f5f9;border:none;border-radius:20px;font-size:0.9rem;cursor:pointer;margin-bottom:15px}
        .back-btn:hover{background:#e2e8f0}
        
        /* é˜…è¯»åŠŸèƒ½æ ·å¼ */
        .story-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .story-header-title{font-size:1.1rem;font-weight:700}
        .story-category-select{padding:8px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.9rem;background:white;cursor:pointer}
        .story-category-select:focus{outline:none;border-color:var(--primary)}
        .story-list{display:flex;flex-direction:column;gap:12px;max-height:400px;overflow-y:auto}
        .story-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f8fafc;border-radius:12px;cursor:pointer;transition:all 0.2s;border:2px solid transparent}
        .story-item:hover{background:#eef2ff;border-color:var(--primary-light);transform:translateX(5px)}
        .story-item-left{flex:1}
        .story-item-title{font-weight:600;margin-bottom:4px;font-size:0.95rem}
        .story-item-title-cn{font-size:0.85rem;color:var(--text-secondary)}
        .story-item-meta{display:flex;gap:8px;margin-top:6px}
        .story-item-tag{padding:2px 8px;background:#e0e7ff;color:var(--primary-dark);border-radius:10px;font-size:0.7rem}
        .story-item-words{font-size:0.7rem;color:var(--text-secondary)}
        .story-item-arrow{color:var(--text-secondary);font-size:1.2rem}
        .story-pagination{display:flex;justify-content:center;gap:8px;margin-top:15px}
        .page-btn{width:36px;height:36px;border:none;border-radius:50%;background:#f1f5f9;cursor:pointer;font-weight:600}
        .page-btn:hover{background:#e2e8f0}
        .page-btn.active{background:var(--primary);color:white}
        .page-btn:disabled{opacity:0.3;cursor:not-allowed}
        
        .story-reader-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .speak-story-btn{padding:8px 15px;background:var(--primary-light);border:none;border-radius:20px;cursor:pointer;font-size:0.9rem}
        .speak-story-btn:hover{background:var(--primary);color:white}
        .story-title-section{text-align:center;margin-bottom:25px;padding-bottom:20px;border-bottom:1px solid #e2e8f0}
        .story-title{font-size:1.4rem;font-weight:700;margin-bottom:5px}
        .story-title-cn{color:var(--text-secondary);font-size:1rem;margin-bottom:10px}
        .story-meta{display:flex;justify-content:center;gap:12px}
        .story-category-tag{padding:4px 12px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;border-radius:15px;font-size:0.8rem}
        .story-word-count{color:var(--text-secondary);font-size:0.85rem}
        .story-content-section{margin-bottom:20px}
        .story-toggle{display:flex;gap:8px;margin-bottom:15px;justify-content:center}
        .toggle-btn{padding:8px 16px;border:2px solid #e2e8f0;background:white;border-radius:20px;cursor:pointer;font-size:0.85rem;transition:all 0.2s}
        .toggle-btn:hover{border-color:var(--primary-light)}
        .toggle-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
        .story-content{line-height:1.9;font-size:1.05rem}
        .story-content .en{margin-bottom:15px}
        .story-content .cn{color:var(--text-secondary);font-size:0.95rem}
        .story-content .word{cursor:pointer;border-bottom:1px dashed var(--primary-light);transition:all 0.2s}
        .story-content .word:hover{background:#eef2ff;color:var(--primary)}
        .story-content .word.known{color:var(--success);border-bottom-color:var(--success)}
        .story-vocab-section{padding-top:15px;border-top:1px solid #e2e8f0}
        .vocab-section-title{font-weight:600;margin-bottom:10px;font-size:0.9rem}
        .vocab-list{display:flex;flex-direction:column;gap:8px}
        .vocab-item{padding:10px 12px;background:#f8fafc;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
        .vocab-item-word{font-weight:600;color:var(--primary)}
        .vocab-item-meaning{font-size:0.9rem;color:var(--text-secondary)}
        
        /* å¬å†™åŠŸèƒ½æ ·å¼ */
        .dictation-header{margin-bottom:20px}
        .dictation-title{font-size:1.2rem;font-weight:700}
        .dictation-settings .setting-group{margin-bottom:20px}
        .dictation-settings .setting-label{font-weight:600;margin-bottom:10px;font-size:0.9rem}
        .dictation-select{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:1rem;background:white}
        .dictation-select:focus{outline:none;border-color:var(--primary)}
        .mode-btns,.word-count-btns{display:flex;gap:8px;flex-wrap:wrap}
        .mode-btn,.count-btn{flex:1;min-width:80px;padding:10px 12px;border:2px solid #e2e8f0;background:white;border-radius:10px;font-size:0.9rem;cursor:pointer;transition:all 0.2s}
        .mode-btn:hover,.count-btn:hover{border-color:var(--primary-light);background:#f8fafc}
        .mode-btn.active,.count-btn.active{border-color:var(--primary);background:var(--primary);color:white}
        .dictation-preview{margin:20px 0;padding:15px;background:#f8fafc;border-radius:12px}
        .preview-label{font-size:0.9rem;color:var(--text-secondary);margin-bottom:10px}
        .preview-words{display:flex;flex-wrap:wrap;gap:6px}
        .preview-words span{padding:4px 10px;background:white;border-radius:15px;font-size:0.8rem;border:1px solid #e2e8f0}
        
        .dictation-progress{margin-bottom:25px}
        .dictation-progress span{font-size:0.9rem;color:var(--text-secondary);display:block;text-align:center;margin-bottom:8px}
        .dictation-word-card{text-align:center;padding:30px;background:linear-gradient(135deg,#f8fafc,#eef2ff);border-radius:16px;margin-bottom:25px}
        .play-btn{width:80px;height:80px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;font-size:2rem;cursor:pointer;box-shadow:0 8px 25px rgba(99,102,241,0.3);transition:all 0.2s}
        .play-btn:hover{transform:scale(1.1);box-shadow:0 12px 35px rgba(99,102,241,0.4)}
        .play-btn:active{transform:scale(0.95)}
        .play-hint{margin-top:15px;color:var(--text-secondary);font-size:0.9rem}
        .play-count{margin-top:8px;color:var(--primary);font-size:0.85rem;font-weight:600}
        
        .dictation-mode-a,.dictation-mode-b{margin-bottom:20px}
        .mode-label{font-weight:600;margin-bottom:12px;text-align:center}
        .choice-btns{display:flex;flex-direction:column;gap:10px}
        .choice-btn{padding:14px 18px;border:2px solid #e2e8f0;background:white;border-radius:12px;text-align:left;font-size:1rem;cursor:pointer;transition:all 0.2s}
        .choice-btn:hover{border-color:var(--primary-light);background:#f8fafc}
        .choice-btn.correct{border-color:var(--success);background:#ecfdf5;color:var(--success)}
        .choice-btn.wrong{border-color:var(--danger);background:#fef2f2;color:var(--danger)}
        .choice-btn.disabled{pointer-events:none;opacity:0.7}
        
        .spelling-input{width:100%;padding:15px;border:2px solid #e2e8f0;border-radius:12px;font-size:1.2rem;text-align:center;margin-bottom:15px;letter-spacing:2px}
        .spelling-input:focus{outline:none;border-color:var(--primary)}
        .spelling-input.correct{border-color:var(--success);background:#ecfdf5}
        .spelling-input.wrong{border-color:var(--danger);background:#fef2f2}
        
        .dictation-feedback{text-align:center;padding:20px;background:#f8fafc;border-radius:12px;margin-bottom:20px}
        .feedback-icon{font-size:3rem;margin-bottom:10px}
        .feedback-word{font-size:1.8rem;font-weight:700;color:var(--primary);margin-bottom:5px}
        .feedback-phonetic{color:var(--text-secondary);margin-bottom:5px}
        .feedback-chinese{font-size:1.1rem;margin-bottom:15px}
        
        .dictation-result{text-align:center;padding:20px}
        .result-icon{font-size:4rem;margin-bottom:15px}
        .result-title{font-size:1.5rem;font-weight:700;margin-bottom:20px}
        .result-score{margin-bottom:25px}
        .score-label{display:block;font-size:0.9rem;color:var(--text-secondary);margin-bottom:5px}
        .score-value{font-size:3rem;font-weight:800;color:var(--primary)}
        .score-total{font-size:1.5rem;color:var(--text-secondary)}
        .result-detail{margin-bottom:25px;text-align:left}
        .result-item{display:flex;align-items:center;gap:10px;padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:8px}
        .result-item.correct{background:#ecfdf5}
        .result-item.wrong{background:#fef2f2}
        .result-item-icon{font-size:1.2rem}
        .result-item-word{font-weight:600;flex:1}
        .result-item-chinese{color:var(--text-secondary);font-size:0.9rem}
        
        /* æ¸¸æˆåŠŸèƒ½æ ·å¼ */
        .game-menu-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
        .game-menu-title{font-size:1.3rem;font-weight:700}
        .game-coins{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:white;padding:6px 14px;border-radius:20px;font-weight:700;font-size:0.95rem}
        .game-menu-subtitle{color:var(--text-secondary);margin-bottom:20px}
        .game-list{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
        .game-card{display:flex;align-items:center;gap:15px;padding:18px;background:linear-gradient(135deg,#f8fafc,#eef2ff);border-radius:16px;cursor:pointer;transition:all 0.3s;border:2px solid transparent}
        .game-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(99,102,241,0.15);border-color:var(--primary-light)}
        .game-card-icon{font-size:2.5rem;width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:white;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
        .game-card-info{flex:1}
        .game-card-title{font-weight:700;font-size:1.1rem;margin-bottom:4px}
        .game-card-desc{font-size:0.85rem;color:var(--text-secondary)}
        .game-card-arrow{font-size:1.5rem;color:var(--text-secondary)}
        .game-settings{padding-top:15px;border-top:1px solid #e2e8f0}
        
        /* æ¸¸æˆé€šç”¨æ ·å¼ */
        .game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .game-back{background:none;border:none;font-size:1.5rem;cursor:pointer;padding:5px}
        .game-title{font-size:1.2rem;font-weight:700}
        .game-stats{display:flex;gap:15px}
        .game-stat{display:flex;align-items:center;gap:5px;font-weight:600}
        .game-stat-icon{font-size:1.1rem}
        
        /* æ€ªå…½æ¸¸æˆæ ·å¼ */
        .monster-arena{height:400px;background:linear-gradient(180deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);border-radius:16px;position:relative;overflow:hidden;margin-bottom:15px}
        .stars{position:absolute;width:100%;height:100%;overflow:hidden}
        .star{position:absolute;background:white;border-radius:50%;animation:twinkle 1.5s infinite}
        @keyframes twinkle{0%,100%{opacity:0.3}50%{opacity:1}}
        .monster{position:absolute;left:50%;transform:translateX(-50%);text-align:center;transition:top 0.1s linear;z-index:10}
        .monster-emoji{font-size:4rem;filter:drop-shadow(0 0 20px rgba(255,100,100,0.5));animation:monsterFloat 1s ease-in-out infinite}
        @keyframes monsterFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        .monster-word{background:rgba(0,0,0,0.7);color:#fff;padding:8px 20px;border-radius:25px;font-size:1.4rem;font-weight:700;margin-top:5px;border:2px solid #ff6b6b}
        .monster-choices{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .monster-choice{padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:12px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s}
        .monster-choice:hover{transform:scale(1.03);box-shadow:0 5px 20px rgba(102,126,234,0.4)}
        .monster-choice:active{transform:scale(0.97)}
        .monster-choice.correct{background:linear-gradient(135deg,#10b981,#059669);animation:pulse 0.3s}
        .monster-choice.wrong{background:linear-gradient(135deg,#ef4444,#dc2626);animation:shake 0.3s}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .explosion{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:6rem;animation:explode 0.5s forwards;z-index:20}
        @keyframes explode{0%{opacity:1;transform:translate(-50%,-50%) scale(0.5)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.5)}100%{opacity:0;transform:translate(-50%,-50%) scale(2)}}
        .combo-display{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#f59e0b,#f97316);color:white;padding:5px 15px;border-radius:20px;font-weight:700;font-size:0.9rem;opacity:0;transition:opacity 0.3s}
        .combo-display.show{opacity:1}
        
        /* å­—æ¯è‹±é›„æ ·å¼ */
        .spelling-arena{min-height:250px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:16px;padding:30px 20px;text-align:center;margin-bottom:15px}
        .spelling-word{display:flex;justify-content:center;gap:8px;margin-bottom:30px;flex-wrap:wrap}
        .spelling-letter{width:45px;height:55px;background:white;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:700;color:var(--primary);box-shadow:0 4px 15px rgba(0,0,0,0.2)}
        .spelling-letter.blank{background:rgba(255,255,255,0.3);border:3px dashed white;color:transparent}
        .spelling-letter.filled{background:#10b981;color:white;animation:popIn 0.3s}
        .spelling-letter.wrong-letter{background:#ef4444;color:white;animation:shake 0.3s}
        @keyframes popIn{0%{transform:scale(0.5)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
        .spelling-hint{color:rgba(255,255,255,0.9);font-size:1.1rem;margin-bottom:10px}
        .keyboard{display:grid;grid-template-columns:repeat(9,1fr);gap:6px;max-width:400px;margin:0 auto}
        .key-btn{padding:12px 5px;background:white;border:none;border-radius:8px;font-size:1.1rem;font-weight:700;cursor:pointer;transition:all 0.15s;box-shadow:0 3px 0 #d1d5db}
        .key-btn:hover{background:#f3f4f6}
        .key-btn:active{transform:translateY(2px);box-shadow:0 1px 0 #d1d5db}
        .key-btn.used{opacity:0.4;pointer-events:none}
        .key-btn.correct-key{background:#10b981;color:white;box-shadow:0 3px 0 #059669}
        .key-btn.wrong-key{background:#ef4444;color:white;box-shadow:0 3px 0 #dc2626}
        
        /* ç«ç®­æ¸¸æˆæ ·å¼ */
        .rocket-arena{height:400px;background:linear-gradient(180deg,#0f0c29 0%,#302b63 50%,#24243e 100%);border-radius:16px;position:relative;overflow:hidden;margin-bottom:15px}
        .rocket-track{position:absolute;left:30px;top:20px;bottom:80px;width:4px;background:rgba(255,255,255,0.2);border-radius:2px}
        .rocket-progress{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(180deg,#fbbf24,#f59e0b);border-radius:2px;transition:height 0.5s ease-out}
        .rocket{position:absolute;left:10px;bottom:60px;font-size:3rem;transition:bottom 0.5s ease-out;filter:drop-shadow(0 0 20px rgba(251,191,36,0.6))}
        .rocket.boost{animation:rocketBoost 0.5s}
        @keyframes rocketBoost{0%{transform:scale(1)}25%{transform:scale(1.2) rotate(-5deg)}50%{transform:scale(1.3) rotate(5deg)}75%{transform:scale(1.2) rotate(-3deg)}100%{transform:scale(1)}}
        .rocket-flame{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:1.5rem;opacity:0.8;animation:flame 0.2s infinite}
        @keyframes flame{0%,100%{transform:translateX(-50%) scaleY(1)}50%{transform:translateX(-50%) scaleY(1.3)}}
        .rocket-question{position:absolute;right:20px;top:50%;transform:translateY(-50%);width:280px;background:rgba(255,255,255,0.95);border-radius:16px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
        .rocket-word{font-size:1.6rem;font-weight:700;color:var(--primary);text-align:center;margin-bottom:15px}
        .rocket-options{display:flex;flex-direction:column;gap:8px}
        .rocket-option{padding:12px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:10px;cursor:pointer;font-size:0.95rem;transition:all 0.2s;text-align:left}
        .rocket-option:hover{border-color:var(--primary);background:#eef2ff}
        .rocket-option.correct{background:#ecfdf5;border-color:#10b981;color:#059669}
        .rocket-option.wrong{background:#fef2f2;border-color:#ef4444;color:#dc2626}
        .altitude{position:absolute;top:15px;right:15px;background:rgba(0,0,0,0.5);color:white;padding:8px 15px;border-radius:20px;font-weight:600}
        
        /* é…å¯¹æ¶ˆæ¶ˆä¹æ ·å¼ */
        .match-arena{padding:15px;background:linear-gradient(135deg,#e0f2fe,#ddd6fe);border-radius:16px;margin-bottom:15px}
        .match-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
        .match-card{aspect-ratio:1;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.9rem;font-weight:600;color:white;transition:all 0.3s;transform-style:preserve-3d;position:relative}
        .match-card:hover{transform:scale(1.05)}
        .match-card.flipped{background:white;color:var(--text-primary);transform:rotateY(180deg)}
        .match-card.matched{background:linear-gradient(135deg,#10b981,#059669);color:white;transform:scale(0.95);pointer-events:none}
        .match-card-front,.match-card-back{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;backface-visibility:hidden;border-radius:12px;padding:8px;text-align:center;word-break:break-word}
        .match-card-front{background:linear-gradient(135deg,#667eea,#764ba2)}
        .match-card-back{background:white;transform:rotateY(180deg);color:var(--text-primary);border:2px solid #e2e8f0}
        .match-card.flipped .match-card-front{visibility:hidden}
        .match-card.flipped .match-card-back{visibility:visible}
        .match-timer{text-align:center;font-size:2rem;font-weight:700;color:var(--primary);margin-bottom:10px}
        
        /* æ¸¸æˆç»“æŸæ ·å¼ */
        .game-over{text-align:center;padding:30px}
        .game-over-icon{font-size:5rem;margin-bottom:15px}
        .game-over-title{font-size:1.8rem;font-weight:700;margin-bottom:10px}
        .game-over-score{font-size:3rem;font-weight:800;color:var(--primary);margin-bottom:5px}
        .game-over-detail{color:var(--text-secondary);margin-bottom:20px}
        .game-over-coins{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:white;padding:10px 25px;border-radius:25px;font-weight:700;font-size:1.1rem;margin-bottom:25px}
        .high-score{background:linear-gradient(135deg,#f59e0b,#f97316);color:white;padding:5px 15px;border-radius:20px;font-size:0.9rem;margin-bottom:20px;display:inline-block}
    </style>
</head>
<body>
    <div class="container login-container" id="loginPage">
        <div class="card login-card">
            <div class="login-logo">ğŸ“š</div>
            <div class="login-title">è¯æ±‡æ˜Ÿçƒ</div>
            <div class="login-subtitle">æŒæ¡1000ä¸ªæœ€å¸¸ç”¨è‹±è¯­å•è¯</div>
            <input type="text" class="input" id="usernameInput" placeholder="è¾“å…¥ä½ çš„åå­—" maxlength="10">
            <button class="btn btn-primary" onclick="createUser()">å¼€å§‹å­¦ä¹ </button>
            <div class="divider"><span>æˆ–é€‰æ‹©å·²æœ‰è´¦æˆ·</span></div>
            <div class="user-list" id="userList"></div>
        </div>
    </div>

    <div class="container app-container" id="appPage">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ“š</div>
                <span class="logo-text">è¯æ±‡æ˜Ÿçƒ</span>
            </div>
            <div class="header-right">
                <div class="user-badge" onclick="toggleSettings()">
                    <div class="avatar avatar-sm" id="headerAvatar">T</div>
                    <span id="headerName">Tom</span>
                </div>
                <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
            </div>
        </header>

        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <span style="color:var(--text-secondary)">å­¦ä¹ è¿›åº¦</span>
                <div class="streak-badge">ğŸ”¥ <span id="streakDays">0</span>å¤©</div>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="learnedCount">0</div>
                    <div class="stat-label">å·²å­¦å•è¯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="masteredCount">0</div>
                    <div class="stat-label">å·²æŒæ¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentLesson">1</div>
                    <div class="stat-label">å½“å‰è¯¾ç¨‹</div>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-header">
                    <span>æ€»ä½“è¿›åº¦</span>
                    <span><span id="progressPct">0</span>%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width:0%"></div>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="learn" onclick="switchTab('learn')">ğŸ“– å­¦ä¹ </button>
            <button class="nav-tab" data-tab="reading" onclick="switchTab('reading')">ğŸ“š é˜…è¯»</button>
            <button class="nav-tab" data-tab="dictation" onclick="switchTab('dictation')">ğŸ§ å¬å†™</button>
            <button class="nav-tab" data-tab="games" onclick="switchTab('games')">ğŸ® æ¸¸æˆ</button>
            <button class="nav-tab" data-tab="practice" onclick="switchTab('practice')">âœï¸ ç»ƒä¹ </button>
            <button class="nav-tab" data-tab="test" onclick="switchTab('test')">ğŸ“ æµ‹éªŒ</button>
        </div>

        <div class="section active" id="section-learn">
            <div class="card lesson-selector" id="lessonSelector">
                <div class="lesson-selector-header">
                    <span class="lesson-selector-title">ğŸ“š é€‰æ‹©è¯¾ç¨‹</span>
                    <div class="lesson-nav">
                        <button class="lesson-nav-btn" id="lessonPrev" onclick="changeLessonPage(-1)">â—€</button>
                        <button class="lesson-nav-btn" id="lessonNext" onclick="changeLessonPage(1)">â–¶</button>
                    </div>
                </div>
                <div class="lesson-grid" id="lessonGrid"></div>
                <div class="lesson-info" id="lessonInfo"></div>
            </div>
            
            <div class="card hidden" id="previewCard">
                <button class="back-btn" onclick="backToLessonSelect()">â† è¿”å›è¯¾ç¨‹</button>
                <div class="preview-header">
                    <span class="preview-title">ğŸ“‹ ç¬¬ <span id="lessonTitle">1</span> è¯¾</span>
                    <span id="previewCount">0/15</span>
                </div>
                <div class="preview-list" id="previewList"></div>
                <button class="btn btn-primary" id="startBtn" onclick="startLearning()">å¼€å§‹å­¦ä¹ </button>
            </div>
            <div class="card word-card hidden" id="wordCard">
                <div class="word-progress">ç¬¬ <span id="wordIdx">1</span> / <span id="wordTotal">15</span> ä¸ª</div>
                <button class="speak-btn" onclick="speakWord()">ğŸ”Š</button>
                <div class="word-english" id="wordEn">hello</div>
                <div class="word-phonetic" id="wordPh">/hÉ™ËˆloÊŠ/</div>
                <div class="word-chinese" id="wordCn">ä½ å¥½</div>
                <div class="word-category" id="wordCat">é—®å€™</div>
                <div id="examplesBox"></div>
            </div>
            <div class="btn-group hidden" id="learnBtns">
                <button class="btn btn-secondary" onclick="markWord(false)">ğŸ˜° ä¸ç†Ÿ</button>
                <button class="btn btn-primary" onclick="markWord(true)">ğŸ˜Š ä¸‹ä¸€ä¸ª</button>
            </div>
        </div>

        <div class="section" id="section-reading">
            <div class="card" id="storyListCard">
                <div class="story-header">
                    <span class="story-header-title">ğŸ“š é˜…è¯»çŸ­æ–‡</span>
                    <select class="story-category-select" id="storyCategorySelect" onchange="filterStories()">
                        <option value="all">å…¨éƒ¨åˆ†ç±»</option>
                        <option value="åäººè¶£äº‹">åäººè¶£äº‹</option>
                        <option value="å¹½é»˜æ•…äº‹">å¹½é»˜æ•…äº‹</option>
                        <option value="ç»å…¸å¯“è¨€">ç»å…¸å¯“è¨€</option>
                        <option value="å“²ç†æ•…äº‹">å“²ç†æ•…äº‹</option>
                        <option value="æ¸©æƒ…æ•…äº‹">æ¸©æƒ…æ•…äº‹</option>
                        <option value="ç»å…¸ç«¥è¯">ç»å…¸ç«¥è¯</option>
                    </select>
                </div>
                <div class="story-list" id="storyList"></div>
                <div class="story-pagination" id="storyPagination"></div>
            </div>
            
            <div class="card story-reader" id="storyReader" style="display:none;">
                <div class="story-reader-header">
                    <button class="back-btn" onclick="closeStory()">â† è¿”å›</button>
                    <button class="speak-story-btn" onclick="speakStory()">ğŸ”Š æœ—è¯»</button>
                </div>
                <div class="story-title-section">
                    <h2 class="story-title" id="storyTitle"></h2>
                    <div class="story-title-cn" id="storyTitleCn"></div>
                    <div class="story-meta">
                        <span class="story-category-tag" id="storyCategory"></span>
                        <span class="story-word-count" id="storyWordCount"></span>
                    </div>
                </div>
                <div class="story-content-section">
                    <div class="story-toggle">
                        <button class="toggle-btn active" onclick="setReadingMode('en')">è‹±æ–‡</button>
                        <button class="toggle-btn" onclick="setReadingMode('cn')">ä¸­æ–‡</button>
                        <button class="toggle-btn" onclick="setReadingMode('both')">åŒè¯­</button>
                    </div>
                    <div class="story-content" id="storyContent"></div>
                </div>
                <div class="story-vocab-section" id="storyVocabSection" style="display:none;">
                    <div class="vocab-section-title">ğŸ“ ç‚¹å‡»çš„ç”Ÿè¯</div>
                    <div class="vocab-list" id="storyVocabList"></div>
                </div>
            </div>
        </div>

        <div class="section" id="section-dictation">
            <div class="card">
                <div class="dictation-header">
                    <span class="dictation-title">ğŸ§ å¬å†™ç»ƒä¹ </span>
                </div>
                
                <!-- è®¾ç½®åŒºåŸŸ -->
                <div class="dictation-settings" id="dictationSettings">
                    <div class="setting-group">
                        <div class="setting-label">ğŸ“š é€‰æ‹©è¯æº</div>
                        <select class="dictation-select" id="dictationSource" onchange="updateDictationPreview()">
                            <option value="lesson">å½“å‰è¯¾ç¨‹å•è¯</option>
                            <option value="recent">æœ€è¿‘å­¦è¿‡çš„å•è¯</option>
                            <option value="story">é˜…è¯»çŸ­æ–‡ç”Ÿè¯</option>
                        </select>
                    </div>
                    
                    <div class="setting-group" id="lessonSelectGroup">
                        <div class="setting-label">ğŸ“– é€‰æ‹©è¯¾ç¨‹</div>
                        <select class="dictation-select" id="dictationLesson" onchange="updateDictationPreview()"></select>
                    </div>
                    
                    <div class="setting-group" id="storySelectGroup" style="display:none;">
                        <div class="setting-label">ğŸ“– é€‰æ‹©çŸ­æ–‡</div>
                        <select class="dictation-select" id="dictationStory" onchange="updateDictationPreview()"></select>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-label">ğŸ¯ å¬å†™æ¨¡å¼</div>
                        <div class="mode-btns">
                            <button class="mode-btn active" data-mode="a" onclick="setDictationMode('a')">A. é€‰ä¸­æ–‡</button>
                            <button class="mode-btn" data-mode="b" onclick="setDictationMode('b')">B. æ‹¼å•è¯</button>
                            <button class="mode-btn" data-mode="ab" onclick="setDictationMode('ab')">A+B å®Œæ•´</button>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-label">ğŸ“ å•è¯æ•°é‡</div>
                        <div class="word-count-btns">
                            <button class="count-btn" onclick="setDictationCount(5)">5ä¸ª</button>
                            <button class="count-btn active" onclick="setDictationCount(10)">10ä¸ª</button>
                            <button class="count-btn" onclick="setDictationCount(15)">15ä¸ª</button>
                            <button class="count-btn" onclick="setDictationCount(20)">å…¨éƒ¨</button>
                        </div>
                    </div>
                    
                    <div class="dictation-preview">
                        <div class="preview-label">å¾…å¬å†™å•è¯ï¼š<span id="dictationWordCount">0</span> ä¸ª</div>
                        <div class="preview-words" id="dictationPreviewWords"></div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="startDictation()">ğŸ§ å¼€å§‹å¬å†™</button>
                </div>
                
                <!-- å¬å†™åŒºåŸŸ -->
                <div class="dictation-area" id="dictationArea" style="display:none;">
                    <div class="dictation-progress">
                        <span id="dictationProgress">1/10</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="dictationProgressBar" style="width:10%"></div>
                        </div>
                    </div>
                    
                    <div class="dictation-word-card">
                        <button class="play-btn" onclick="playDictationWord()">ğŸ”Š</button>
                        <div class="play-hint">ç‚¹å‡»æ’­æ”¾å•è¯å‘éŸ³</div>
                        <div class="play-count" id="playCount">å·²æ’­æ”¾: 0 æ¬¡</div>
                    </div>
                    
                    <!-- Aæ¨¡å¼ï¼šé€‰æ‹©ä¸­æ–‡ -->
                    <div class="dictation-mode-a" id="dictationModeA" style="display:none;">
                        <div class="mode-label">é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡æ„æ€ï¼š</div>
                        <div class="choice-btns" id="chineseChoices"></div>
                    </div>
                    
                    <!-- Bæ¨¡å¼ï¼šæ‹¼å†™å•è¯ -->
                    <div class="dictation-mode-b" id="dictationModeB" style="display:none;">
                        <div class="mode-label">è¯·æ‹¼å†™è¿™ä¸ªå•è¯ï¼š</div>
                        <input type="text" class="spelling-input" id="spellingInput" placeholder="è¾“å…¥è‹±æ–‡å•è¯..." autocomplete="off" autocapitalize="none">
                        <button class="btn btn-primary" onclick="checkSpelling()">ç¡®è®¤</button>
                    </div>
                    
                    <!-- ç»“æœåé¦ˆ -->
                    <div class="dictation-feedback" id="dictationFeedback" style="display:none;">
                        <div class="feedback-icon" id="feedbackIcon"></div>
                        <div class="feedback-word" id="feedbackWord"></div>
                        <div class="feedback-phonetic" id="feedbackPhonetic"></div>
                        <div class="feedback-chinese" id="feedbackChinese"></div>
                        <button class="btn btn-primary" onclick="nextDictationWord()">ä¸‹ä¸€ä¸ª â†’</button>
                    </div>
                </div>
                
                <!-- ç»“æœåŒºåŸŸ -->
                <div class="dictation-result" id="dictationResult" style="display:none;">
                    <div class="result-icon">ğŸ‰</div>
                    <div class="result-title">å¬å†™å®Œæˆï¼</div>
                    <div class="result-score">
                        <span class="score-label">å¾—åˆ†</span>
                        <span class="score-value" id="dictationScore">0</span>
                        <span class="score-total" id="dictationTotal">/10</span>
                    </div>
                    <div class="result-detail" id="resultDetail"></div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="showDictationSettings()">è¿”å›è®¾ç½®</button>
                        <button class="btn btn-primary" onclick="startDictation()">å†æ¥ä¸€æ¬¡</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="section-games">
            <div class="card" id="gameMenu">
                <div class="game-menu-header">
                    <span class="game-menu-title">ğŸ® å•è¯æ¸¸æˆ</span>
                    <div class="game-coins">ğŸ’ <span id="totalCoins">0</span></div>
                </div>
                <div class="game-menu-subtitle">é€‰æ‹©ä¸€ä¸ªæ¸¸æˆå¼€å§‹æŒ‘æˆ˜ï¼</div>
                
                <div class="game-list">
                    <div class="game-card" onclick="selectGame('monster')">
                        <div class="game-card-icon">ğŸ‘¾</div>
                        <div class="game-card-info">
                            <div class="game-card-title">æ€ªå…½å…¥ä¾µ</div>
                            <div class="game-card-desc">æ€ªå…½ä»å¤©è€Œé™ï¼é€‰å¯¹ä¸­æ–‡æ„æ€æ¶ˆç­å®ƒä»¬</div>
                        </div>
                        <div class="game-card-arrow">â€º</div>
                    </div>
                    
                    <div class="game-card" onclick="selectGame('spelling')">
                        <div class="game-card-icon">ğŸ”¤</div>
                        <div class="game-card-info">
                            <div class="game-card-title">å­—æ¯è‹±é›„</div>
                            <div class="game-card-desc">å•è¯ç¼ºäº†å­—æ¯ï¼å¿«é€Ÿé€‰æ‹©æ­£ç¡®å­—æ¯</div>
                        </div>
                        <div class="game-card-arrow">â€º</div>
                    </div>
                    
                    <div class="game-card" onclick="selectGame('rocket')">
                        <div class="game-card-icon">ğŸš€</div>
                        <div class="game-card-info">
                            <div class="game-card-title">å•è¯ç«ç®­</div>
                            <div class="game-card-desc">ç«ç®­å‡ç©ºï¼è¿ç»­ç­”å¯¹è®©ç«ç®­é£å¾—æ›´é«˜</div>
                        </div>
                        <div class="game-card-arrow">â€º</div>
                    </div>
                    
                    <div class="game-card" onclick="selectGame('match')">
                        <div class="game-card-icon">ğŸ§©</div>
                        <div class="game-card-info">
                            <div class="game-card-title">é…å¯¹æ¶ˆæ¶ˆä¹</div>
                            <div class="game-card-desc">ç¿»ç‰Œé…å¯¹ï¼æ‰¾å‡ºè‹±æ–‡å’Œä¸­æ–‡çš„å¯¹åº”</div>
                        </div>
                        <div class="game-card-arrow">â€º</div>
                    </div>
                </div>
                
                <div class="game-settings">
                    <div class="setting-label">ğŸ“– è¯æºèŒƒå›´</div>
                    <select class="dictation-select" id="gameWordSource">
                        <option value="learned">å·²å­¦è¿‡çš„å•è¯</option>
                        <option value="lesson">æŒ‡å®šè¯¾ç¨‹å•è¯</option>
                    </select>
                </div>
            </div>
            
            <!-- æ¸¸æˆåŒºåŸŸ -->
            <div id="gameArea" style="display:none;"></div>
        </div>

        <div class="section" id="section-practice">
            <div class="card day-selector">
                <div class="day-selector-title">é€‰æ‹©ç»ƒä¹ èŒƒå›´ï¼ˆæœ€è¿‘Nè¯¾ï¼‰</div>
                <div class="day-btns" id="practiceDayBtns"></div>
            </div>
            <div id="practiceArea"></div>
        </div>

        <div class="section" id="section-test">
            <div class="card day-selector">
                <div class="day-selector-title">é€‰æ‹©æµ‹éªŒèŒƒå›´ï¼ˆæœ€è¿‘Nè¯¾ï¼‰</div>
                <div class="day-btns" id="testDayBtns"></div>
            </div>
            <div id="testArea"></div>
        </div>
    </div>

    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span class="settings-title">âš™ï¸ è®¾ç½®</span>
            <button class="close-btn" onclick="toggleSettings()">âœ•</button>
        </div>
        <div class="settings-content">
            <div class="setting-group">
                <div class="setting-label">ğŸ‘¤ å½“å‰ç”¨æˆ·</div>
                <div id="settingsUserName" style="color:var(--primary);font-weight:600"></div>
            </div>
            <div class="setting-group">
                <div class="setting-label">ğŸ“ æ¯è¯¾å•è¯æ•°</div>
                <input type="range" class="slider" id="dailySlider" min="5" max="30" value="15" oninput="updateSliderValue()">
                <div class="slider-value"><span id="dailyValue">15</span> ä¸ª/è¯¾</div>
            </div>
            <div class="setting-group">
                <div class="setting-label">ğŸ”Š å‘éŸ³å£éŸ³</div>
                <select class="input" id="accentSelect">
                    <option value="us">ç¾å¼å‘éŸ³</option>
                    <option value="uk">è‹±å¼å‘éŸ³</option>
                </select>
            </div>
            <div class="setting-group">
                <div class="setting-label">ğŸ”ˆ è‡ªåŠ¨å‘éŸ³</div>
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="autoSpeakCheck" style="width:20px;height:20px;">
                    <span>æ˜¾ç¤ºå•è¯æ—¶è‡ªåŠ¨æ’­æ”¾å‘éŸ³</span>
                </label>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
            <div class="logout-section">
                <button class="logout-btn" onclick="logout()">ğŸšª åˆ‡æ¢ç”¨æˆ·</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">ğŸ‰</div>
            <div class="modal-title" id="modalTitle">å®Œæˆï¼</div>
            <div class="modal-msg" id="modalMsg"></div>
            <button class="btn btn-primary" onclick="closeModal()">ç¡®å®š</button>
        </div>
    </div>

<script>
let vocab = [];
let stories = [];
let allUsers = {};
let currentUser = null;
let state = {
    lessonPage: 0,
    selectedLesson: 1,
    lessonWords: [],
    wordIdx: 0,
    isLearning: false,
    practiceLessons: 1,
    testLessons: 1,
    practiceWords: [],
    practiceIdx: 0,
    testWords: [],
    testIdx: 0,
    testResults: [],
    // é˜…è¯»ç›¸å…³çŠ¶æ€
    storyPage: 0,
    storyCategory: 'all',
    currentStory: null,
    readingMode: 'en',
    clickedWords: [],
    // å¬å†™ç›¸å…³çŠ¶æ€
    dictationMode: 'a',
    dictationCount: 10,
    dictationSource: 'lesson',
    dictationWords: [],
    dictationIdx: 0,
    dictationResults: [],
    dictationPlayCount: 0,
    dictationPhase: 'a',
    // æ¸¸æˆç›¸å…³çŠ¶æ€
    currentGame: null,
    gameWords: [],
    gameIdx: 0,
    gameScore: 0,
    gameCombo: 0,
    gameLives: 3,
    gameTimer: null,
    monsterY: -100,
    rocketAltitude: 0,
    matchCards: [],
    matchFlipped: [],
    matchPairs: 0
};

async function init() {
    await loadVocabulary();
    await loadStories();
    loadUsers();
    const saved = localStorage.getItem('vp_current');
    if (saved && allUsers[saved]) login(saved);
}

async function loadVocabulary() {
    try {
        const res = await fetch('data/words.json');
        vocab = await res.json();
        console.log(`è¯åº“åŠ è½½æˆåŠŸ: ${vocab.length} ä¸ªå•è¯`);
    } catch (e) {
        console.error('è¯åº“åŠ è½½å¤±è´¥', e);
        vocab = [];
    }
}

async function loadStories() {
    try {
        const res = await fetch('stories.json');
        stories = await res.json();
        console.log(`çŸ­æ–‡åŠ è½½æˆåŠŸ: ${stories.length} ç¯‡`);
    } catch (e) {
        console.error('çŸ­æ–‡åŠ è½½å¤±è´¥', e);
        stories = [];
    }
}

function loadUsers() {
    const data = localStorage.getItem('vp_users');
    if (data) allUsers = JSON.parse(data);
    renderUserList();
}

function saveUsers() {
    localStorage.setItem('vp_users', JSON.stringify(allUsers));
}

function renderUserList() {
    const list = document.getElementById('userList');
    const names = Object.keys(allUsers);
    if (!names.length) {
        list.innerHTML = '<div class="no-users">è¿˜æ²¡æœ‰ç”¨æˆ·ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>';
        return;
    }
    list.innerHTML = names.map(n => {
        const u = allUsers[n];
        const currentLesson = Math.floor(u.learned.length / u.settings.daily) + 1;
        return `<div class="user-item" onclick="login('${n}')">
            <div class="user-info">
                <div class="avatar">${n[0].toUpperCase()}</div>
                <div>
                    <div class="user-name">${n}</div>
                    <div class="user-progress">ç¬¬${currentLesson}è¯¾ Â· å·²æŒæ¡${u.mastered.length}è¯</div>
                </div>
            </div>
            <button class="user-delete" onclick="event.stopPropagation();deleteUser('${n}')">Ã—</button>
        </div>`;
    }).join('');
}

function createUser() {
    const name = document.getElementById('usernameInput').value.trim();
    if (!name) return alert('è¯·è¾“å…¥åå­—');
    if (!allUsers[name]) {
        allUsers[name] = {
            name,
            learned: [],
            mastered: [],
            lessonProgress: {},
            streak: 0,
            lastDate: null,
            settings: { daily: 15, accent: 'us', autoSpeak: false }
        };
    }
    saveUsers();
    login(name);
}

function deleteUser(name) {
    if (confirm(`ç¡®å®šåˆ é™¤ "${name}"ï¼Ÿ`)) {
        delete allUsers[name];
        saveUsers();
        renderUserList();
    }
}

function login(name) {
    currentUser = name;
    localStorage.setItem('vp_current', name);
    checkStreak();
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appPage').classList.add('active');
    document.getElementById('headerAvatar').textContent = name[0].toUpperCase();
    document.getElementById('headerName').textContent = name;
    document.getElementById('settingsUserName').textContent = name;
    
    state.selectedLesson = getCurrentLesson();
    state.lessonPage = Math.floor((state.selectedLesson - 1) / 10);
    
    renderLessonSelector();
    updateStats();
    renderDayButtons();
}

function logout() {
    currentUser = null;
    localStorage.removeItem('vp_current');
    document.getElementById('appPage').classList.remove('active');
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('usernameInput').value = '';
    toggleSettings();
    renderUserList();
}

function checkStreak() {
    const u = allUsers[currentUser];
    const today = new Date().toDateString();
    if (u.lastDate) {
        const last = new Date(u.lastDate).toDateString();
        if (last !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            u.streak = (last === yesterday.toDateString()) ? u.streak + 1 : 1;
        }
    } else {
        u.streak = 1;
    }
    u.lastDate = new Date().toISOString();
    saveUsers();
}

function getTotalLessons() {
    const u = allUsers[currentUser];
    return Math.ceil(vocab.length / u.settings.daily);
}

function getCurrentLesson() {
    const u = allUsers[currentUser];
    const total = getTotalLessons();
    for (let i = 1; i <= total; i++) {
        const words = getLessonWords(i);
        const done = u.lessonProgress[i] || [];
        if (done.length < words.length) return i;
    }
    return total;
}

function getLessonWords(lessonNum) {
    const u = allUsers[currentUser];
    const perLesson = u.settings.daily;
    const start = (lessonNum - 1) * perLesson;
    return vocab.slice(start, start + perLesson);
}

function isLessonCompleted(lessonNum) {
    const u = allUsers[currentUser];
    const words = getLessonWords(lessonNum);
    const done = u.lessonProgress[lessonNum] || [];
    return done.length >= words.length;
}

function renderLessonSelector() {
    const total = getTotalLessons();
    const perPage = 10;
    const maxPage = Math.ceil(total / perPage) - 1;
    
    document.getElementById('lessonPrev').disabled = state.lessonPage <= 0;
    document.getElementById('lessonNext').disabled = state.lessonPage >= maxPage;
    
    const start = state.lessonPage * perPage + 1;
    const end = Math.min(start + perPage - 1, total);
    const u = allUsers[currentUser];
    const currentL = getCurrentLesson();
    
    let html = '';
    for (let i = start; i <= end; i++) {
        const completed = isLessonCompleted(i);
        const isCurrent = i === currentL;
        const progress = u.lessonProgress[i] || [];
        const words = getLessonWords(i);
        const isSelected = i === state.selectedLesson;
        
        let statusClass = completed ? 'completed' : (isCurrent ? 'current' : '');
        if (isSelected) statusClass += ' selected';
        
        let statusText = completed ? 'å·²å®Œæˆ' : (isCurrent ? (progress.length > 0 ? `${progress.length}/${words.length}` : 'å½“å‰') : (progress.length > 0 ? `${progress.length}/${words.length}` : ''));
        
        html += `<div class="lesson-item ${statusClass}" onclick="selectLesson(${i})">
            ${completed ? '<span class="lesson-check">âœ“</span>' : ''}
            <span class="lesson-num">${i}</span>
            <span class="lesson-status">${statusText}</span>
        </div>`;
    }
    
    document.getElementById('lessonGrid').innerHTML = html;
    updateLessonInfo(state.selectedLesson);
}

function changeLessonPage(delta) {
    const total = getTotalLessons();
    const maxPage = Math.ceil(total / 10) - 1;
    state.lessonPage = Math.max(0, Math.min(maxPage, state.lessonPage + delta));
    renderLessonSelector();
}

function selectLesson(lessonNum) {
    state.selectedLesson = lessonNum;
    renderLessonSelector();
}

function updateLessonInfo(lessonNum) {
    const words = getLessonWords(lessonNum);
    const u = allUsers[currentUser];
    const done = u.lessonProgress[lessonNum] || [];
    const completed = done.length >= words.length;
    
    let btnHtml = '';
    if (completed) {
        btnHtml = `<button class="btn btn-success" onclick="startLesson(${lessonNum})" style="margin-top:15px">ğŸ”„ å¤ä¹ æœ¬è¯¾</button>`;
    } else if (done.length > 0) {
        btnHtml = `<button class="btn btn-warning" onclick="startLesson(${lessonNum})" style="margin-top:15px">â–¶ ç»§ç»­å­¦ä¹ </button>`;
    } else {
        btnHtml = `<button class="btn btn-primary" onclick="startLesson(${lessonNum})" style="margin-top:15px">ğŸ“– å¼€å§‹å­¦ä¹ </button>`;
    }
    
    const previewWords = words.slice(0, 8).map(w => {
        const isLearned = done.includes(w.word);
        return `<span class="lesson-word-tag" style="${isLearned ? 'background:var(--success);color:white;border-color:var(--success)' : ''}">${w.word}</span>`;
    }).join('') + (words.length > 8 ? `<span class="lesson-word-tag">+${words.length - 8}</span>` : '');
    
    document.getElementById('lessonInfo').innerHTML = `
        <div class="lesson-info-title">ç¬¬ ${lessonNum} è¯¾</div>
        <div class="lesson-info-detail">å…± ${words.length} ä¸ªå•è¯ Â· å·²å­¦ ${done.length} ä¸ª${completed ? ' Â· âœ… å·²å®Œæˆ' : ''}</div>
        <div class="lesson-words-preview">${previewWords}</div>
        ${btnHtml}
    `;
}

function startLesson(lessonNum) {
    state.selectedLesson = lessonNum;
    state.lessonWords = getLessonWords(lessonNum);
    
    const u = allUsers[currentUser];
    const done = u.lessonProgress[lessonNum] || [];
    
    state.wordIdx = 0;
    for (let i = 0; i < state.lessonWords.length; i++) {
        if (!done.includes(state.lessonWords[i].word)) {
            state.wordIdx = i;
            break;
        }
    }
    
    if (done.length >= state.lessonWords.length) state.wordIdx = 0;
    
    state.isLearning = false;
    
    document.getElementById('lessonSelector').classList.add('hidden');
    document.getElementById('previewCard').classList.remove('hidden');
    document.getElementById('lessonTitle').textContent = lessonNum;
    
    renderPreview();
}

function backToLessonSelect() {
    document.getElementById('lessonSelector').classList.remove('hidden');
    document.getElementById('previewCard').classList.add('hidden');
    document.getElementById('wordCard').classList.add('hidden');
    document.getElementById('learnBtns').classList.add('hidden');
    state.isLearning = false;
    renderLessonSelector();
}

function renderPreview() {
    const u = allUsers[currentUser];
    const lessonNum = state.selectedLesson;
    const done = u.lessonProgress[lessonNum] || [];
    
    document.getElementById('previewList').innerHTML = state.lessonWords.map((w, i) => {
        const isDone = done.includes(w.word);
        const isCurrent = i === state.wordIdx && state.isLearning;
        return `<span class="preview-word ${isDone ? 'learned' : ''} ${isCurrent ? 'current' : ''}">${w.word}</span>`;
    }).join('');
    
    document.getElementById('previewCount').textContent = `${done.length}/${state.lessonWords.length}`;
    
    const btn = document.getElementById('startBtn');
    const allDone = done.length >= state.lessonWords.length;
    
    if (allDone) {
        btn.textContent = 'ğŸ”„ å†å­¦ä¸€é';
        btn.className = 'btn btn-success';
    } else if (state.wordIdx > 0 || done.length > 0) {
        btn.textContent = 'â–¶ ç»§ç»­å­¦ä¹ ';
        btn.className = 'btn btn-warning';
    } else {
        btn.textContent = 'ğŸ“– å¼€å§‹å­¦ä¹ ';
        btn.className = 'btn btn-primary';
    }
}

function startLearning() {
    if (state.lessonWords.length === 0) return;
    
    const u = allUsers[currentUser];
    const lessonNum = state.selectedLesson;
    const done = u.lessonProgress[lessonNum] || [];
    
    if (done.length >= state.lessonWords.length) state.wordIdx = 0;
    
    state.isLearning = true;
    document.getElementById('previewCard').classList.add('hidden');
    document.getElementById('wordCard').classList.remove('hidden');
    document.getElementById('learnBtns').classList.remove('hidden');
    document.getElementById('wordTotal').textContent = state.lessonWords.length;
    showWord();
}

function showWord() {
    if (state.wordIdx >= state.lessonWords.length) {
        finishLearning();
        return;
    }
    const w = state.lessonWords[state.wordIdx];
    document.getElementById('wordIdx').textContent = state.wordIdx + 1;
    document.getElementById('wordEn').textContent = w.word;
    document.getElementById('wordPh').textContent = w.phonetic;
    document.getElementById('wordCn').textContent = w.chinese;
    document.getElementById('wordCat').textContent = w.category;
    
    document.getElementById('examplesBox').innerHTML = w.examples.map((ex, i) => `
        <div class="example">
            <div class="example-label">ä¾‹å¥${i + 1} <span onclick="speakExample(${i})" style="cursor:pointer;font-size:1rem;margin-left:5px;">ğŸ”Š</span></div>
            <div class="example-en">${ex.en.replace(new RegExp(`(${w.word})`, 'gi'), '<span class="hl">$1</span>')}</div>
            <div class="example-cn">${ex.cn}</div>
        </div>
    `).join('');
    
    // è‡ªåŠ¨å‘éŸ³
    const u = allUsers[currentUser];
    if (u.settings.autoSpeak) {
        setTimeout(() => speakWord(), 300);
    }
}

function markWord(known) {
    const u = allUsers[currentUser];
    const w = state.lessonWords[state.wordIdx];
    const lessonNum = state.selectedLesson;
    
    if (!u.lessonProgress[lessonNum]) u.lessonProgress[lessonNum] = [];
    if (!u.learned.includes(w.word)) u.learned.push(w.word);
    if (!u.lessonProgress[lessonNum].includes(w.word)) u.lessonProgress[lessonNum].push(w.word);
    
    state.wordIdx++;
    saveUsers();
    updateStats();
    showWord();
}

function finishLearning() {
    state.isLearning = false;
    document.getElementById('wordCard').classList.add('hidden');
    document.getElementById('learnBtns').classList.add('hidden');
    document.getElementById('previewCard').classList.remove('hidden');
    renderPreview();
    
    const u = allUsers[currentUser];
    const lessonNum = state.selectedLesson;
    const done = u.lessonProgress[lessonNum] || [];
    
    if (done.length >= state.lessonWords.length) {
        showModal('ğŸ‰', `ç¬¬ ${lessonNum} è¯¾å®Œæˆï¼`, 'å¤ªæ£’äº†ï¼å»ç»ƒä¹ å·©å›ºä¸€ä¸‹å§ï¼');
    }
}

function speakWord() {
    if (state.wordIdx >= state.lessonWords.length) return;
    const w = state.lessonWords[state.wordIdx];
    const u = allUsers[currentUser];
    
    // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°éŸ³é¢‘æ–‡ä»¶
    const audioFile = `audio/${String(w.rank).padStart(4, '0')}_${w.word}.mp3`;
    const audio = new Audio(audioFile);
    
    audio.onerror = () => {
        // æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå›é€€åˆ°æµè§ˆå™¨TTS
        console.log('æœ¬åœ°éŸ³é¢‘ä¸å­˜åœ¨ï¼Œä½¿ç”¨æµè§ˆå™¨TTS');
        speakWithTTS(w.word, u);
    };
    
    audio.play().catch(() => {
        // æ’­æ”¾å¤±è´¥ï¼Œå›é€€åˆ°æµè§ˆå™¨TTS
        speakWithTTS(w.word, u);
    });
}

function speakWithTTS(text, u) {
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = u && u.settings && u.settings.accent === 'uk' ? 'en-GB' : 'en-US';
        utterance.rate = 0.85;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        if (selectedVoice) {
            utterance.voice = selectedVoice;
        }
        
        utterance.onerror = (e) => console.error('è¯­éŸ³é”™è¯¯:', e);
        
        speechSynthesis.speak(utterance);
    }
}

// è¯­éŸ³ç³»ç»Ÿåˆå§‹åŒ–
let voicesReady = false;
let selectedVoice = null;

function initSpeech() {
    if (!('speechSynthesis' in window)) return;
    
    function loadVoices() {
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
            voicesReady = true;
            // ä¼˜å…ˆé€‰æ‹©é«˜è´¨é‡è‹±è¯­è¯­éŸ³
            const preferredVoices = [
                'Google US English',
                'Microsoft Aria',
                'Microsoft Jenny',
                'Samantha',
                'Alex'
            ];
            
            for (const pref of preferredVoices) {
                const found = voices.find(v => v.name.includes(pref));
                if (found) {
                    selectedVoice = found;
                    console.log('é€‰æ‹©è¯­éŸ³:', found.name);
                    break;
                }
            }
            
            if (!selectedVoice) {
                // å¤‡é€‰ï¼šæ‰¾è‹±è¯­è¯­éŸ³
                selectedVoice = voices.find(v => v.lang.startsWith('en')) || voices[0];
                console.log('å¤‡é€‰è¯­éŸ³:', selectedVoice?.name);
            }
        }
    }
    
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;
    
    // æŸäº›æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾ï¼Œé¢„çƒ­ä¸€ä¸‹
    document.addEventListener('click', function warmup() {
        if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance('');
            u.volume = 0;
            speechSynthesis.speak(u);
        }
        document.removeEventListener('click', warmup);
    }, { once: true });
}

initSpeech();

function speakExample(idx) {
    if (state.wordIdx >= state.lessonWords.length) return;
    const w = state.lessonWords[state.wordIdx];
    const ex = w.examples[idx];
    if (!ex) return;
    
    const u = allUsers[currentUser];
    
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(ex.en);
        utterance.lang = u.settings.accent === 'uk' ? 'en-GB' : 'en-US';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        if (selectedVoice) {
            utterance.voice = selectedVoice;
        }
        
        speechSynthesis.speak(utterance);
    }
}

function updateStats() {
    const u = allUsers[currentUser];
    const currentLesson = getCurrentLesson();
    
    document.getElementById('streakDays').textContent = u.streak;
    document.getElementById('learnedCount').textContent = u.learned.length;
    document.getElementById('masteredCount').textContent = u.mastered.length;
    document.getElementById('currentLesson').textContent = currentLesson;
    
    const pct = vocab.length > 0 ? ((u.learned.length / vocab.length) * 100).toFixed(1) : 0;
    document.getElementById('progressPct').textContent = pct;
    document.getElementById('progressBar').style.width = pct + '%';
}

function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + tab).classList.add('active');
    
    if (tab === 'learn') backToLessonSelect();
    if (tab === 'practice') initPractice();
    if (tab === 'test') initTest();
    if (tab === 'reading') renderStoryList();
    if (tab === 'dictation') initDictation();
    if (tab === 'games') initGames();
}

function renderDayButtons() {
    const u = allUsers[currentUser];
    const completedLessons = Object.keys(u.lessonProgress).filter(k => {
        const words = getLessonWords(parseInt(k));
        return (u.lessonProgress[k] || []).length > 0;
    }).length;
    
    const availLessons = Math.max(1, completedLessons);
    
    ['practice', 'test'].forEach(type => {
        const container = document.getElementById(type + 'DayBtns');
        let html = '';
        for (let i = 1; i <= 5; i++) {
            const active = (type === 'practice' ? state.practiceLessons : state.testLessons) === i;
            const disabled = i > availLessons;
            html += `<button class="day-btn ${active ? 'active' : ''}" ${disabled ? 'disabled' : ''} onclick="selectLessons('${type}', ${i})">${i}è¯¾</button>`;
        }
        container.innerHTML = html;
    });
}

function selectLessons(type, lessons) {
    if (type === 'practice') {
        state.practiceLessons = lessons;
        initPractice();
    } else {
        state.testLessons = lessons;
        initTest();
    }
    renderDayButtons();
}

function getWordsForLessons(numLessons) {
    const u = allUsers[currentUser];
    const wordSet = new Set();
    const learnedLessons = Object.keys(u.lessonProgress).map(Number).sort((a, b) => b - a);
    
    let count = 0;
    for (const lessonNum of learnedLessons) {
        if (count >= numLessons) break;
        const done = u.lessonProgress[lessonNum] || [];
        done.forEach(w => wordSet.add(w));
        if (done.length > 0) count++;
    }
    
    return Array.from(wordSet).map(w => vocab.find(v => v.word === w)).filter(Boolean);
}

function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function generateOptions(correct, count = 4) {
    const others = vocab.filter(w => w.word !== correct).map(w => w.word);
    return shuffle([correct, ...shuffle(others).slice(0, count - 1)]);
}

function initPractice() {
    const words = getWordsForLessons(state.practiceLessons);
    const area = document.getElementById('practiceArea');
    
    if (!words.length) {
        area.innerHTML = '<div class="card"><div style="text-align:center;color:var(--text-secondary);padding:20px">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•ï¼Œå…ˆå»å­¦ä¹ å§ï¼</div></div>';
        return;
    }
    
    state.practiceWords = shuffle(words);
    state.practiceIdx = 0;
    showPracticeQuestion();
}

function showPracticeQuestion() {
    const area = document.getElementById('practiceArea');
    
    if (state.practiceIdx >= state.practiceWords.length) {
        state.practiceIdx = 0;
        state.practiceWords = shuffle(state.practiceWords);
    }
    
    const w = state.practiceWords[state.practiceIdx];
    const ex = w.examples[Math.floor(Math.random() * w.examples.length)];
    const sentence = ex.en.replace(new RegExp(`\\b${w.word}\\b`, 'gi'), '___');
    const options = generateOptions(w.word);
    
    area.innerHTML = `
        <div class="card">
            <div class="quiz-header">
                <span class="quiz-type">å¡«ç©ºç»ƒä¹ </span>
                <span>${state.practiceIdx + 1} / ${state.practiceWords.length}</span>
            </div>
            <div class="quiz-question">${sentence.replace('___', '<span class="blank"></span>')}</div>
            <div class="quiz-hint">æç¤ºï¼š${w.chinese}</div>
            <div class="quiz-options">
                ${options.map(o => `<button class="quiz-option" onclick="checkPractice(this, '${o}', '${w.word}')">${o}</button>`).join('')}
            </div>
        </div>
    `;
}

function checkPractice(btn, selected, correct) {
    document.querySelectorAll('#practiceArea .quiz-option').forEach(o => {
        o.classList.add('disabled');
        if (o.textContent === correct) o.classList.add('correct');
        else if (o === btn && selected !== correct) o.classList.add('wrong');
    });
    
    setTimeout(() => {
        state.practiceIdx++;
        showPracticeQuestion();
    }, 1000);
}

function initTest() {
    const words = getWordsForLessons(state.testLessons);
    const area = document.getElementById('testArea');
    
    if (!words.length) {
        area.innerHTML = '<div class="card"><div style="text-align:center;color:var(--text-secondary);padding:20px">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•ï¼Œå…ˆå»å­¦ä¹ å§ï¼</div></div>';
        return;
    }
    
    area.innerHTML = `
        <div class="card" style="text-align:center">
            <p style="font-size:1.1rem;margin-bottom:15px">æµ‹éªŒåŒ…å« <strong>${words.length}</strong> ä¸ªå•è¯</p>
            <p style="color:var(--text-secondary);margin-bottom:20px">ç­”å¯¹çš„å•è¯å°†æ ‡è®°ä¸º"å·²æŒæ¡"</p>
            <button class="btn btn-primary" onclick="startTest()">å¼€å§‹æµ‹éªŒ</button>
        </div>
    `;
}

function startTest() {
    const words = getWordsForLessons(state.testLessons);
    state.testWords = shuffle(words);
    state.testIdx = 0;
    state.testResults = [];
    showTestQuestion();
}

function showTestQuestion() {
    const area = document.getElementById('testArea');
    
    if (state.testIdx >= state.testWords.length) {
        showTestResults();
        return;
    }
    
    const w = state.testWords[state.testIdx];
    const ex = w.examples[Math.floor(Math.random() * w.examples.length)];
    const sentence = ex.en.replace(new RegExp(`\\b${w.word}\\b`, 'gi'), '___');
    const options = generateOptions(w.word);
    
    area.innerHTML = `
        <div class="card">
            <div class="quiz-header">
                <span class="quiz-type">ğŸ“ æµ‹éªŒ</span>
                <span>${state.testIdx + 1} / ${state.testWords.length}</span>
            </div>
            <div class="quiz-question">${sentence.replace('___', '<span class="blank"></span>')}</div>
            <div class="quiz-hint">æç¤ºï¼š${w.chinese}</div>
            <div class="quiz-options">
                ${options.map(o => `<button class="quiz-option" onclick="checkTest(this, '${o}', '${w.word}')">${o}</button>`).join('')}
            </div>
        </div>
    `;
}

function checkTest(btn, selected, correct) {
    const isCorrect = selected === correct;
    state.testResults.push({ word: correct, correct: isCorrect });
    
    if (isCorrect) {
        const u = allUsers[currentUser];
        if (!u.mastered.includes(correct)) {
            u.mastered.push(correct);
            saveUsers();
        }
    }
    
    document.querySelectorAll('#testArea .quiz-option').forEach(o => {
        o.classList.add('disabled');
        if (o.textContent === correct) o.classList.add('correct');
        else if (o === btn && !isCorrect) o.classList.add('wrong');
    });
    
    setTimeout(() => {
        state.testIdx++;
        updateStats();
        showTestQuestion();
    }, 1000);
}

function showTestResults() {
    const area = document.getElementById('testArea');
    const correctCount = state.testResults.filter(r => r.correct).length;
    const total = state.testResults.length;
    const pct = Math.round((correctCount / total) * 100);
    
    area.innerHTML = `
        <div class="card result-card">
            <div class="result-icon">${pct >= 60 ? 'ğŸ‰' : 'ğŸ˜¢'}</div>
            <div class="result-title">${pct >= 60 ? 'æµ‹éªŒé€šè¿‡ï¼' : 'ç»§ç»­åŠ æ²¹ï¼'}</div>
            <div class="result-score">${pct}%</div>
            <div class="result-detail">${correctCount} / ${total} æ­£ç¡®</div>
            <button class="btn btn-primary" onclick="initTest()">å†æµ‹ä¸€æ¬¡</button>
        </div>
    `;
}

function toggleSettings() {
    document.getElementById('settingsOverlay').classList.toggle('open');
    document.getElementById('settingsPanel').classList.toggle('open');
    
    if (currentUser) {
        const u = allUsers[currentUser];
        document.getElementById('dailySlider').value = u.settings.daily;
        document.getElementById('dailyValue').textContent = u.settings.daily;
        document.getElementById('accentSelect').value = u.settings.accent;
        document.getElementById('autoSpeakCheck').checked = u.settings.autoSpeak || false;
    }
}

function updateSliderValue() {
    document.getElementById('dailyValue').textContent = document.getElementById('dailySlider').value;
}

function saveSettings() {
    const u = allUsers[currentUser];
    u.settings.daily = parseInt(document.getElementById('dailySlider').value);
    u.settings.accent = document.getElementById('accentSelect').value;
    u.settings.autoSpeak = document.getElementById('autoSpeakCheck').checked;
    saveUsers();
    toggleSettings();
    renderLessonSelector();
    updateStats();
    showModal('âœ…', 'è®¾ç½®å·²ä¿å­˜', '');
}

function showModal(icon, title, msg) {
    document.getElementById('modalIcon').textContent = icon;
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMsg').textContent = msg;
    document.getElementById('modal').classList.add('show');
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

// ==================== é˜…è¯»åŠŸèƒ½ ====================

function renderStoryList() {
    const container = document.getElementById('storyList');
    const category = state.storyCategory;
    
    // è¿‡æ»¤æ•…äº‹
    let filtered = stories;
    if (category !== 'all') {
        filtered = stories.filter(s => s.category === category);
    }
    
    // åˆ†é¡µ
    const perPage = 8;
    const totalPages = Math.ceil(filtered.length / perPage);
    const start = state.storyPage * perPage;
    const pageStories = filtered.slice(start, start + perPage);
    
    if (pageStories.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:30px;">æš‚æ— çŸ­æ–‡</div>';
        document.getElementById('storyPagination').innerHTML = '';
        return;
    }
    
    container.innerHTML = pageStories.map(s => `
        <div class="story-item" onclick="openStory(${s.id})">
            <div class="story-item-left">
                <div class="story-item-title">${s.title}</div>
                <div class="story-item-title-cn">${s.titleCn}</div>
                <div class="story-item-meta">
                    <span class="story-item-tag">${s.category}</span>
                    <span class="story-item-words">${s.wordCount} è¯</span>
                </div>
            </div>
            <div class="story-item-arrow">â€º</div>
        </div>
    `).join('');
    
    // åˆ†é¡µæŒ‰é’®
    if (totalPages > 1) {
        let pagination = '';
        pagination += `<button class="page-btn" onclick="changeStoryPage(-1)" ${state.storyPage === 0 ? 'disabled' : ''}>â€¹</button>`;
        for (let i = 0; i < Math.min(totalPages, 5); i++) {
            const pageNum = state.storyPage < 3 ? i : state.storyPage - 2 + i;
            if (pageNum >= totalPages) break;
            pagination += `<button class="page-btn ${pageNum === state.storyPage ? 'active' : ''}" onclick="goToStoryPage(${pageNum})">${pageNum + 1}</button>`;
        }
        pagination += `<button class="page-btn" onclick="changeStoryPage(1)" ${state.storyPage === totalPages - 1 ? 'disabled' : ''}>â€º</button>`;
        document.getElementById('storyPagination').innerHTML = pagination;
    } else {
        document.getElementById('storyPagination').innerHTML = '';
    }
}

function filterStories() {
    state.storyCategory = document.getElementById('storyCategorySelect').value;
    state.storyPage = 0;
    renderStoryList();
}

function changeStoryPage(delta) {
    const category = state.storyCategory;
    let filtered = stories;
    if (category !== 'all') {
        filtered = stories.filter(s => s.category === category);
    }
    const totalPages = Math.ceil(filtered.length / 8);
    
    state.storyPage = Math.max(0, Math.min(totalPages - 1, state.storyPage + delta));
    renderStoryList();
}

function goToStoryPage(page) {
    state.storyPage = page;
    renderStoryList();
}

function openStory(id) {
    const story = stories.find(s => s.id === id);
    if (!story) return;
    
    state.currentStory = story;
    state.clickedWords = [];
    state.readingMode = 'en';
    
    document.getElementById('storyListCard').style.display = 'none';
    document.getElementById('storyReader').style.display = 'block';
    
    document.getElementById('storyTitle').textContent = story.title;
    document.getElementById('storyTitleCn').textContent = story.titleCn;
    document.getElementById('storyCategory').textContent = story.category;
    document.getElementById('storyWordCount').textContent = story.wordCount + ' è¯';
    
    renderStoryContent();
    
    // é‡ç½®åˆ‡æ¢æŒ‰é’®
    document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.toggle-btn[onclick="setReadingMode(\'en\')"]').classList.add('active');
    
    document.getElementById('storyVocabSection').style.display = 'none';
    document.getElementById('storyVocabList').innerHTML = '';
}

function closeStory() {
    document.getElementById('storyListCard').style.display = 'block';
    document.getElementById('storyReader').style.display = 'none';
    state.currentStory = null;
}

function setReadingMode(mode) {
    state.readingMode = mode;
    renderStoryContent();
    
    document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.toggle-btn[onclick="setReadingMode('${mode}')"]`).classList.add('active');
}

function renderStoryContent() {
    const story = state.currentStory;
    if (!story) return;
    
    const container = document.getElementById('storyContent');
    const mode = state.readingMode;
    const u = allUsers[currentUser];
    
    // å¤„ç†è‹±æ–‡å†…å®¹ï¼Œè®©æ¯ä¸ªå•è¯å¯ç‚¹å‡»
    const processedEn = story.content.split(/(\s+|[.,!?;:'"()-])/).map(word => {
        if (/^[a-zA-Z]+$/.test(word)) {
            const lower = word.toLowerCase();
            const isKnown = u && u.learned && u.learned.includes(lower);
            return `<span class="word ${isKnown ? 'known' : ''}" onclick="clickWord('${lower}')">${word}</span>`;
        }
        return word;
    }).join('');
    
    if (mode === 'en') {
        container.innerHTML = `<div class="en">${processedEn}</div>`;
    } else if (mode === 'cn') {
        container.innerHTML = `<div class="cn">${story.contentCn}</div>`;
    } else {
        container.innerHTML = `
            <div class="en">${processedEn}</div>
            <div class="cn">${story.contentCn}</div>
        `;
    }
}

function clickWord(word) {
    // åœ¨è¯åº“ä¸­æŸ¥æ‰¾
    const found = vocab.find(v => v.word.toLowerCase() === word.toLowerCase());
    
    if (found) {
        // æ·»åŠ åˆ°å·²ç‚¹å‡»åˆ—è¡¨
        if (!state.clickedWords.find(w => w.word === found.word)) {
            state.clickedWords.push(found);
        }
        
        // æ˜¾ç¤ºç”Ÿè¯åŒºåŸŸ
        document.getElementById('storyVocabSection').style.display = 'block';
        renderClickedWords();
        
        // æ’­æ”¾å‘éŸ³
        speakText(found.word);
    } else {
        // è¯åº“ä¸­æ²¡æœ‰ï¼Œå°è¯•åœ¨çº¿æŸ¥è¯¢æˆ–æç¤º
        speakText(word);
    }
}

function renderClickedWords() {
    const container = document.getElementById('storyVocabList');
    container.innerHTML = state.clickedWords.map(w => `
        <div class="vocab-item">
            <div>
                <span class="vocab-item-word">${w.word}</span>
                <span style="color:var(--text-secondary);font-size:0.8rem;margin-left:8px">${w.phonetic}</span>
            </div>
            <div class="vocab-item-meaning">${w.chinese}</div>
        </div>
    `).join('');
}

function speakText(text) {
    // å¦‚æœæ˜¯å•ä¸ªå•è¯ï¼Œå°è¯•ç”¨æœ¬åœ°éŸ³é¢‘
    if (/^[a-zA-Z]+$/.test(text)) {
        const word = text.toLowerCase();
        const found = vocab.find(v => v.word.toLowerCase() === word);
        if (found) {
            const audioFile = `audio/${String(found.rank).padStart(4, '0')}_${found.word}.mp3`;
            const audio = new Audio(audioFile);
            audio.onerror = () => speakWithTTS(text, allUsers[currentUser]);
            audio.play().catch(() => speakWithTTS(text, allUsers[currentUser]));
            return;
        }
    }
    
    // å¥å­æˆ–è¯åº“å¤–çš„å•è¯ç”¨TTS
    speakWithTTS(text, allUsers[currentUser]);
}

function speakStory() {
    const story = state.currentStory;
    if (!story) return;
    
    // æ•´ç¯‡æ–‡ç« ç”¨TTSæœ—è¯»
    speakWithTTS(story.content, allUsers[currentUser]);
}

// ==================== å¬å†™åŠŸèƒ½ ====================

function initDictation() {
    // åˆå§‹åŒ–è¯¾ç¨‹é€‰æ‹©å™¨
    const lessonSelect = document.getElementById('dictationLesson');
    const u = allUsers[currentUser];
    const currentLesson = u ? Math.ceil((u.learned?.length || 0) / 15) || 1 : 1;
    
    lessonSelect.innerHTML = '';
    for (let i = 1; i <= Math.min(currentLesson + 5, 67); i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `ç¬¬ ${i} è¯¾`;
        if (i === state.selectedLesson) opt.selected = true;
        lessonSelect.appendChild(opt);
    }
    
    // åˆå§‹åŒ–çŸ­æ–‡é€‰æ‹©å™¨
    const storySelect = document.getElementById('dictationStory');
    storySelect.innerHTML = stories.map(s => 
        `<option value="${s.id}">${s.title} - ${s.titleCn}</option>`
    ).join('');
    
    updateDictationPreview();
    showDictationSettings();
}

function updateDictationPreview() {
    const source = document.getElementById('dictationSource').value;
    state.dictationSource = source;
    
    // æ˜¾ç¤º/éšè—å¯¹åº”çš„é€‰æ‹©å™¨
    document.getElementById('lessonSelectGroup').style.display = 
        (source === 'lesson' || source === 'recent') ? 'block' : 'none';
    document.getElementById('storySelectGroup').style.display = 
        source === 'story' ? 'block' : 'none';
    
    // è·å–å¾…å¬å†™å•è¯
    let words = getDictationSourceWords();
    
    // é™åˆ¶æ•°é‡
    const count = state.dictationCount;
    if (count < words.length) {
        words = shuffleArray([...words]).slice(0, count);
    }
    
    // æ˜¾ç¤ºé¢„è§ˆ
    document.getElementById('dictationWordCount').textContent = words.length;
    document.getElementById('dictationPreviewWords').innerHTML = 
        words.slice(0, 15).map(w => `<span>${w.word}</span>`).join('') +
        (words.length > 15 ? '<span>...</span>' : '');
}

function getDictationSourceWords() {
    const source = state.dictationSource;
    const u = allUsers[currentUser];
    
    if (source === 'lesson') {
        const lesson = parseInt(document.getElementById('dictationLesson').value) || 1;
        return getLessonWords(lesson);
    } else if (source === 'recent') {
        // æœ€è¿‘å­¦è¿‡çš„å•è¯
        const learned = u?.learned || [];
        return vocab.filter(w => learned.includes(w.word.toLowerCase())).slice(-50);
    } else if (source === 'story') {
        // ä»çŸ­æ–‡ä¸­æå–å•è¯
        const storyId = parseInt(document.getElementById('dictationStory').value);
        const story = stories.find(s => s.id === storyId);
        if (!story) return [];
        
        // æå–çŸ­æ–‡ä¸­çš„å•è¯ï¼ŒåŒ¹é…è¯åº“
        const storyWords = story.content.toLowerCase().match(/[a-z]+/g) || [];
        const uniqueWords = [...new Set(storyWords)];
        return vocab.filter(w => uniqueWords.includes(w.word.toLowerCase()));
    }
    return [];
}

function setDictationMode(mode) {
    state.dictationMode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
}

function setDictationCount(count) {
    state.dictationCount = count;
    document.querySelectorAll('.count-btn').forEach((btn, i) => {
        const counts = [5, 10, 15, 999];
        btn.classList.toggle('active', counts[i] === count);
    });
    updateDictationPreview();
}

function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function startDictation() {
    // è·å–å•è¯
    let words = getDictationSourceWords();
    const count = state.dictationCount;
    if (count < words.length) {
        words = shuffleArray([...words]).slice(0, count);
    } else {
        words = shuffleArray([...words]);
    }
    
    if (words.length === 0) {
        showModal('ğŸ˜…', 'æ²¡æœ‰å¯ç”¨å•è¯', 'è¯·å…ˆå­¦ä¹ ä¸€äº›å•è¯æˆ–é€‰æ‹©å…¶ä»–è¯æº');
        return;
    }
    
    state.dictationWords = words;
    state.dictationIdx = 0;
    state.dictationResults = [];
    state.dictationPlayCount = 0;
    
    // æ ¹æ®æ¨¡å¼è®¾ç½®åˆå§‹é˜¶æ®µ
    if (state.dictationMode === 'a') {
        state.dictationPhase = 'a';
    } else if (state.dictationMode === 'b') {
        state.dictationPhase = 'b';
    } else {
        state.dictationPhase = 'a';
    }
    
    document.getElementById('dictationSettings').style.display = 'none';
    document.getElementById('dictationArea').style.display = 'block';
    document.getElementById('dictationResult').style.display = 'none';
    
    showDictationWord();
}

function showDictationSettings() {
    document.getElementById('dictationSettings').style.display = 'block';
    document.getElementById('dictationArea').style.display = 'none';
    document.getElementById('dictationResult').style.display = 'none';
}

function showDictationWord() {
    const words = state.dictationWords;
    const idx = state.dictationIdx;
    const total = words.length;
    
    // æ›´æ–°è¿›åº¦
    document.getElementById('dictationProgress').textContent = `${idx + 1}/${total}`;
    document.getElementById('dictationProgressBar').style.width = `${((idx + 1) / total) * 100}%`;
    
    // é‡ç½®æ’­æ”¾è®¡æ•°
    state.dictationPlayCount = 0;
    document.getElementById('playCount').textContent = 'å·²æ’­æ”¾: 0 æ¬¡';
    
    // éšè—åé¦ˆ
    document.getElementById('dictationFeedback').style.display = 'none';
    
    // æ ¹æ®é˜¶æ®µæ˜¾ç¤ºå¯¹åº”æ¨¡å¼
    const phase = state.dictationPhase;
    document.getElementById('dictationModeA').style.display = phase === 'a' ? 'block' : 'none';
    document.getElementById('dictationModeB').style.display = phase === 'b' ? 'block' : 'none';
    
    if (phase === 'a') {
        showChineseChoices();
    } else if (phase === 'b') {
        document.getElementById('spellingInput').value = '';
        document.getElementById('spellingInput').className = 'spelling-input';
        document.getElementById('spellingInput').focus();
    }
    
    // è‡ªåŠ¨æ’­æ”¾ä¸€æ¬¡
    setTimeout(() => playDictationWord(), 300);
}

function playDictationWord() {
    const word = state.dictationWords[state.dictationIdx];
    if (!word) return;
    
    state.dictationPlayCount++;
    document.getElementById('playCount').textContent = `å·²æ’­æ”¾: ${state.dictationPlayCount} æ¬¡`;
    
    // æ’­æ”¾éŸ³é¢‘
    const audioFile = `audio/${String(word.rank).padStart(4, '0')}_${word.word}.mp3`;
    const audio = new Audio(audioFile);
    audio.onerror = () => speakWithTTS(word.word, allUsers[currentUser]);
    audio.play().catch(() => speakWithTTS(word.word, allUsers[currentUser]));
}

function showChineseChoices() {
    const currentWord = state.dictationWords[state.dictationIdx];
    
    // ç”Ÿæˆ5ä¸ªé€‰é¡¹ï¼š1ä¸ªæ­£ç¡® + 4ä¸ªé”™è¯¯
    let choices = [{ chinese: currentWord.chinese, correct: true }];
    
    // éšæœºé€‰4ä¸ªå…¶ä»–å•è¯çš„ä¸­æ–‡
    const otherWords = vocab.filter(w => w.word !== currentWord.word);
    const shuffled = shuffleArray([...otherWords]);
    for (let i = 0; i < 4 && i < shuffled.length; i++) {
        choices.push({ chinese: shuffled[i].chinese, correct: false });
    }
    
    // æ‰“ä¹±é€‰é¡¹é¡ºåº
    choices = shuffleArray(choices);
    
    const container = document.getElementById('chineseChoices');
    container.innerHTML = choices.map((c, i) => `
        <button class="choice-btn" onclick="selectChinese(${i}, ${c.correct})">
            ${String.fromCharCode(65 + i)}. ${c.chinese}
        </button>
    `).join('');
}

function selectChinese(idx, isCorrect) {
    const btns = document.querySelectorAll('.choice-btn');
    btns.forEach((btn, i) => {
        btn.classList.add('disabled');
        if (i === idx) {
            btn.classList.add(isCorrect ? 'correct' : 'wrong');
        }
        if (btn.textContent.includes(state.dictationWords[state.dictationIdx].chinese)) {
            btn.classList.add('correct');
        }
    });
    
    // è®°å½•ç»“æœ
    if (!state.dictationResults[state.dictationIdx]) {
        state.dictationResults[state.dictationIdx] = { aCorrect: false, bCorrect: false };
    }
    state.dictationResults[state.dictationIdx].aCorrect = isCorrect;
    
    // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€é˜¶æ®µæˆ–ä¸‹ä¸€é¢˜
    setTimeout(() => {
        if (state.dictationMode === 'ab') {
            // A+Bæ¨¡å¼ï¼šè¿›å…¥Bé˜¶æ®µ
            state.dictationPhase = 'b';
            document.getElementById('dictationModeA').style.display = 'none';
            document.getElementById('dictationModeB').style.display = 'block';
            document.getElementById('spellingInput').value = '';
            document.getElementById('spellingInput').className = 'spelling-input';
            document.getElementById('spellingInput').focus();
        } else {
            // çº¯Aæ¨¡å¼ï¼šæ˜¾ç¤ºåé¦ˆ
            showDictationFeedback(isCorrect);
        }
    }, 800);
}

function checkSpelling() {
    const input = document.getElementById('spellingInput');
    const userAnswer = input.value.trim().toLowerCase();
    const correctWord = state.dictationWords[state.dictationIdx].word.toLowerCase();
    const isCorrect = userAnswer === correctWord;
    
    input.classList.add(isCorrect ? 'correct' : 'wrong');
    
    // è®°å½•ç»“æœ
    if (!state.dictationResults[state.dictationIdx]) {
        state.dictationResults[state.dictationIdx] = { aCorrect: false, bCorrect: false };
    }
    state.dictationResults[state.dictationIdx].bCorrect = isCorrect;
    
    setTimeout(() => {
        showDictationFeedback(isCorrect);
    }, 500);
}

function showDictationFeedback(lastCorrect) {
    const word = state.dictationWords[state.dictationIdx];
    const result = state.dictationResults[state.dictationIdx];
    
    // åˆ¤æ–­æ•´ä½“æ˜¯å¦æ­£ç¡®
    let overall = false;
    if (state.dictationMode === 'a') {
        overall = result.aCorrect;
    } else if (state.dictationMode === 'b') {
        overall = result.bCorrect;
    } else {
        overall = result.aCorrect && result.bCorrect;
    }
    
    document.getElementById('dictationModeA').style.display = 'none';
    document.getElementById('dictationModeB').style.display = 'none';
    document.getElementById('dictationFeedback').style.display = 'block';
    
    document.getElementById('feedbackIcon').textContent = overall ? 'âœ…' : 'âŒ';
    document.getElementById('feedbackWord').textContent = word.word;
    document.getElementById('feedbackPhonetic').textContent = word.phonetic;
    document.getElementById('feedbackChinese').textContent = word.chinese;
    
    // æ’­æ”¾æ­£ç¡®å‘éŸ³
    playDictationWord();
}

function nextDictationWord() {
    state.dictationIdx++;
    
    if (state.dictationIdx >= state.dictationWords.length) {
        // å¬å†™å®Œæˆ
        showDictationResult();
    } else {
        // é‡ç½®é˜¶æ®µ
        if (state.dictationMode === 'a') {
            state.dictationPhase = 'a';
        } else if (state.dictationMode === 'b') {
            state.dictationPhase = 'b';
        } else {
            state.dictationPhase = 'a';
        }
        showDictationWord();
    }
}

function showDictationResult() {
    document.getElementById('dictationArea').style.display = 'none';
    document.getElementById('dictationResult').style.display = 'block';
    
    // è®¡ç®—å¾—åˆ†
    let correct = 0;
    state.dictationResults.forEach((r, i) => {
        let isCorrect = false;
        if (state.dictationMode === 'a') {
            isCorrect = r.aCorrect;
        } else if (state.dictationMode === 'b') {
            isCorrect = r.bCorrect;
        } else {
            isCorrect = r.aCorrect && r.bCorrect;
        }
        if (isCorrect) correct++;
    });
    
    document.getElementById('dictationScore').textContent = correct;
    document.getElementById('dictationTotal').textContent = `/${state.dictationWords.length}`;
    
    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
    const detail = document.getElementById('resultDetail');
    detail.innerHTML = state.dictationWords.map((w, i) => {
        const r = state.dictationResults[i] || { aCorrect: false, bCorrect: false };
        let isCorrect = false;
        if (state.dictationMode === 'a') {
            isCorrect = r.aCorrect;
        } else if (state.dictationMode === 'b') {
            isCorrect = r.bCorrect;
        } else {
            isCorrect = r.aCorrect && r.bCorrect;
        }
        return `
            <div class="result-item ${isCorrect ? 'correct' : 'wrong'}">
                <span class="result-item-icon">${isCorrect ? 'âœ…' : 'âŒ'}</span>
                <span class="result-item-word">${w.word}</span>
                <span class="result-item-chinese">${w.chinese}</span>
            </div>
        `;
    }).join('');
}

// ç›‘å¬æ‹¼å†™è¾“å…¥æ¡†å›è½¦é”®
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.getElementById('spellingInput') === document.activeElement) {
        checkSpelling();
    }
});

// ==================== æ¸¸æˆåŠŸèƒ½ ====================

function initGames() {
    // æ˜¾ç¤ºæ¸¸æˆèœå•
    document.getElementById('gameMenu').style.display = 'block';
    document.getElementById('gameArea').style.display = 'none';
    
    // æ›´æ–°é‡‘å¸æ˜¾ç¤º
    const u = allUsers[currentUser];
    document.getElementById('totalCoins').textContent = u?.coins || 0;
    
    // åœæ­¢ä»»ä½•æ­£åœ¨è¿è¡Œçš„æ¸¸æˆ
    if (state.gameTimer) {
        clearInterval(state.gameTimer);
        state.gameTimer = null;
    }
}

function getGameWords() {
    const source = document.getElementById('gameWordSource').value;
    const u = allUsers[currentUser];
    
    if (source === 'learned') {
        const learned = u?.learned || [];
        if (learned.length < 10) {
            // å­¦çš„å•è¯ä¸å¤Ÿï¼Œç”¨å‰å‡ è¯¾
            return vocab.slice(0, 50);
        }
        return vocab.filter(w => learned.includes(w.word.toLowerCase()));
    } else {
        return getLessonWords(state.selectedLesson);
    }
}

function selectGame(gameType) {
    state.currentGame = gameType;
    document.getElementById('gameMenu').style.display = 'none';
    document.getElementById('gameArea').style.display = 'block';
    
    // åˆå§‹åŒ–æ¸¸æˆ
    state.gameScore = 0;
    state.gameCombo = 0;
    state.gameLives = 3;
    state.gameIdx = 0;
    state.gameWords = shuffleArray([...getGameWords()]).slice(0, 15);
    
    if (gameType === 'monster') {
        startMonsterGame();
    } else if (gameType === 'spelling') {
        startSpellingGame();
    } else if (gameType === 'rocket') {
        startRocketGame();
    } else if (gameType === 'match') {
        startMatchGame();
    }
}

function backToGameMenu() {
    if (state.gameTimer) {
        clearInterval(state.gameTimer);
        state.gameTimer = null;
    }
    initGames();
}

// ========== æ€ªå…½å…¥ä¾µæ¸¸æˆ ==========

function startMonsterGame() {
    const area = document.getElementById('gameArea');
    area.innerHTML = `
        <div class="card">
            <div class="game-header">
                <button class="game-back" onclick="backToGameMenu()">â†</button>
                <span class="game-title">ğŸ‘¾ æ€ªå…½å…¥ä¾µ</span>
                <div class="game-stats">
                    <div class="game-stat"><span class="game-stat-icon">ğŸ’</span><span id="monsterScore">0</span></div>
                    <div class="game-stat"><span class="game-stat-icon">â¤ï¸</span><span id="monsterLives">3</span></div>
                </div>
            </div>
            
            <div class="monster-arena" id="monsterArena">
                <div class="stars" id="stars"></div>
                <div class="combo-display" id="comboDisplay">ğŸ”¥ è¿å‡» x0</div>
                <div class="monster" id="monster">
                    <div class="monster-emoji">ğŸ‘¾</div>
                    <div class="monster-word" id="monsterWord">word</div>
                </div>
            </div>
            
            <div class="monster-choices" id="monsterChoices"></div>
        </div>
    `;
    
    // ç”Ÿæˆæ˜Ÿæ˜ŸèƒŒæ™¯
    const stars = document.getElementById('stars');
    for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = star.style.height = (Math.random() * 3 + 1) + 'px';
        star.style.animationDelay = Math.random() * 1.5 + 's';
        stars.appendChild(star);
    }
    
    state.monsterY = -100;
    showNextMonster();
}

function showNextMonster() {
    if (state.gameIdx >= state.gameWords.length || state.gameLives <= 0) {
        endGame('monster');
        return;
    }
    
    const word = state.gameWords[state.gameIdx];
    document.getElementById('monsterWord').textContent = word.word;
    
    // éšæœºæ€ªå…½è¡¨æƒ…
    const monsters = ['ğŸ‘¾', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤–', 'ğŸ‘»', 'ğŸ’€', 'ğŸƒ', 'ğŸ‘½', 'ğŸ¦ ', 'ğŸ™'];
    document.querySelector('.monster-emoji').textContent = monsters[Math.floor(Math.random() * monsters.length)];
    
    // ç”Ÿæˆé€‰é¡¹
    let choices = [{ chinese: word.chinese, correct: true }];
    const others = vocab.filter(w => w.word !== word.word);
    const shuffled = shuffleArray([...others]);
    for (let i = 0; i < 4; i++) {
        choices.push({ chinese: shuffled[i].chinese, correct: false });
    }
    choices = shuffleArray(choices);
    
    document.getElementById('monsterChoices').innerHTML = choices.map((c, i) => `
        <button class="monster-choice" onclick="selectMonsterChoice(${i}, ${c.correct})">${c.chinese}</button>
    `).join('');
    
    // é‡ç½®æ€ªå…½ä½ç½®å¹¶å¼€å§‹ä¸‹è½
    state.monsterY = -100;
    document.getElementById('monster').style.top = state.monsterY + 'px';
    
    if (state.gameTimer) clearInterval(state.gameTimer);
    state.gameTimer = setInterval(() => {
        state.monsterY += 2;
        document.getElementById('monster').style.top = state.monsterY + 'px';
        
        if (state.monsterY > 300) {
            // æ€ªå…½åˆ°è¾¾åº•éƒ¨
            clearInterval(state.gameTimer);
            monsterHit();
        }
    }, 50);
}

function selectMonsterChoice(idx, isCorrect) {
    clearInterval(state.gameTimer);
    
    const btns = document.querySelectorAll('.monster-choice');
    btns.forEach((btn, i) => {
        btn.style.pointerEvents = 'none';
        if (i === idx) {
            btn.classList.add(isCorrect ? 'correct' : 'wrong');
        }
    });
    
    if (isCorrect) {
        // æ¶ˆç­æ€ªå…½
        state.gameScore += 10 + state.gameCombo * 5;
        state.gameCombo++;
        
        // æ˜¾ç¤ºçˆ†ç‚¸æ•ˆæœ
        const arena = document.getElementById('monsterArena');
        const explosion = document.createElement('div');
        explosion.className = 'explosion';
        explosion.textContent = 'ğŸ’¥';
        explosion.style.top = state.monsterY + 50 + 'px';
        arena.appendChild(explosion);
        
        // æ˜¾ç¤ºè¿å‡»
        const combo = document.getElementById('comboDisplay');
        if (state.gameCombo > 1) {
            combo.textContent = `ğŸ”¥ è¿å‡» x${state.gameCombo}`;
            combo.classList.add('show');
        }
        
        // æ’­æ”¾éŸ³æ•ˆï¼ˆç”¨å‘éŸ³ä»£æ›¿ï¼‰
        playDictationWordByWord(state.gameWords[state.gameIdx]);
        
        setTimeout(() => {
            explosion.remove();
            combo.classList.remove('show');
            state.gameIdx++;
            document.getElementById('monsterScore').textContent = state.gameScore;
            showNextMonster();
        }, 600);
    } else {
        monsterHit();
    }
}

function monsterHit() {
    state.gameLives--;
    state.gameCombo = 0;
    document.getElementById('monsterLives').textContent = state.gameLives;
    document.getElementById('comboDisplay').classList.remove('show');
    
    // éœ‡åŠ¨æ•ˆæœ
    document.getElementById('monsterArena').style.animation = 'shake 0.3s';
    setTimeout(() => {
        document.getElementById('monsterArena').style.animation = '';
        state.gameIdx++;
        showNextMonster();
    }, 500);
}

function playDictationWordByWord(word) {
    const audioFile = `audio/${String(word.rank).padStart(4, '0')}_${word.word}.mp3`;
    const audio = new Audio(audioFile);
    audio.onerror = () => speakWithTTS(word.word, allUsers[currentUser]);
    audio.play().catch(() => {});
}

// ========== å­—æ¯è‹±é›„æ¸¸æˆ ==========

function startSpellingGame() {
    const area = document.getElementById('gameArea');
    area.innerHTML = `
        <div class="card">
            <div class="game-header">
                <button class="game-back" onclick="backToGameMenu()">â†</button>
                <span class="game-title">ğŸ”¤ å­—æ¯è‹±é›„</span>
                <div class="game-stats">
                    <div class="game-stat"><span class="game-stat-icon">ğŸ’</span><span id="spellingScore">0</span></div>
                    <div class="game-stat"><span class="game-stat-icon">â¤ï¸</span><span id="spellingLives">3</span></div>
                </div>
            </div>
            
            <div class="spelling-arena">
                <div class="spelling-hint" id="spellingHint">ä¸­æ–‡æç¤º</div>
                <div class="spelling-word" id="spellingWord"></div>
            </div>
            
            <div class="keyboard" id="keyboard"></div>
        </div>
    `;
    
    state.usedKeys = [];
    state.currentBlanks = [];
    state.currentAnswer = [];
    showNextSpellingWord();
}

function showNextSpellingWord() {
    if (state.gameIdx >= state.gameWords.length || state.gameLives <= 0) {
        endGame('spelling');
        return;
    }
    
    const word = state.gameWords[state.gameIdx];
    document.getElementById('spellingHint').textContent = word.chinese;
    
    // å†³å®šéšè—å‡ ä¸ªå­—æ¯ï¼ˆæ ¹æ®å•è¯é•¿åº¦ï¼‰
    const len = word.word.length;
    let blankCount = len <= 3 ? 1 : len <= 5 ? 2 : 3;
    
    // éšæœºé€‰æ‹©è¦éšè—çš„ä½ç½®
    let positions = [];
    for (let i = 0; i < len; i++) positions.push(i);
    positions = shuffleArray(positions).slice(0, blankCount);
    
    state.currentBlanks = positions;
    state.currentAnswer = word.word.toLowerCase().split('');
    state.usedKeys = [];
    state.blanksFound = 0;
    
    // æ¸²æŸ“å•è¯
    renderSpellingWord(word.word, positions);
    
    // æ¸²æŸ“é”®ç›˜
    renderKeyboard();
}

function renderSpellingWord(word, blanks) {
    const container = document.getElementById('spellingWord');
    container.innerHTML = word.split('').map((letter, i) => {
        const isBlank = blanks.includes(i);
        return `<div class="spelling-letter ${isBlank ? 'blank' : ''}" data-index="${i}">${isBlank ? '' : letter}</div>`;
    }).join('');
}

function renderKeyboard() {
    const letters = 'QWERTYUIOPASDFGHJKLZXCVBNM'.split('');
    document.getElementById('keyboard').innerHTML = letters.map(l => `
        <button class="key-btn" onclick="pressKey('${l.toLowerCase()}')">${l}</button>
    `).join('');
}

function pressKey(letter) {
    if (state.usedKeys.includes(letter)) return;
    state.usedKeys.push(letter);
    
    const btn = [...document.querySelectorAll('.key-btn')].find(b => b.textContent.toLowerCase() === letter);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£ç¡®ç­”æ¡ˆ
    let found = false;
    state.currentBlanks.forEach(pos => {
        if (state.currentAnswer[pos] === letter) {
            found = true;
            const letterEl = document.querySelector(`.spelling-letter[data-index="${pos}"]`);
            letterEl.textContent = letter;
            letterEl.classList.remove('blank');
            letterEl.classList.add('filled');
            state.blanksFound++;
        }
    });
    
    if (found) {
        btn.classList.add('correct-key');
        state.gameScore += 5;
        document.getElementById('spellingScore').textContent = state.gameScore;
        
        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
        if (state.blanksFound === state.currentBlanks.length) {
            state.gameScore += 10;
            document.getElementById('spellingScore').textContent = state.gameScore;
            playDictationWordByWord(state.gameWords[state.gameIdx]);
            
            setTimeout(() => {
                state.gameIdx++;
                showNextSpellingWord();
            }, 800);
        }
    } else {
        btn.classList.add('wrong-key');
        state.gameLives--;
        document.getElementById('spellingLives').textContent = state.gameLives;
        
        // æ˜¾ç¤ºé”™è¯¯ä½ç½®æç¤º
        state.currentBlanks.forEach(pos => {
            const letterEl = document.querySelector(`.spelling-letter[data-index="${pos}"]`);
            if (!letterEl.classList.contains('filled')) {
                letterEl.classList.add('wrong-letter');
                setTimeout(() => letterEl.classList.remove('wrong-letter'), 300);
            }
        });
        
        if (state.gameLives <= 0) {
            setTimeout(() => endGame('spelling'), 500);
        }
    }
    
    btn.classList.add('used');
}

// ========== å•è¯ç«ç®­æ¸¸æˆ ==========

function startRocketGame() {
    const area = document.getElementById('gameArea');
    area.innerHTML = `
        <div class="card">
            <div class="game-header">
                <button class="game-back" onclick="backToGameMenu()">â†</button>
                <span class="game-title">ğŸš€ å•è¯ç«ç®­</span>
                <div class="game-stats">
                    <div class="game-stat"><span class="game-stat-icon">ğŸ’</span><span id="rocketScore">0</span></div>
                </div>
            </div>
            
            <div class="rocket-arena">
                <div class="rocket-track">
                    <div class="rocket-progress" id="rocketProgress"></div>
                </div>
                <div class="rocket" id="rocket">ğŸš€<div class="rocket-flame">ğŸ”¥</div></div>
                <div class="altitude">ğŸ” <span id="altitude">0</span>m</div>
                
                <div class="rocket-question" id="rocketQuestion">
                    <div class="rocket-word" id="rocketWord">word</div>
                    <div class="rocket-options" id="rocketOptions"></div>
                </div>
            </div>
        </div>
    `;
    
    state.rocketAltitude = 0;
    showNextRocketQuestion();
}

function showNextRocketQuestion() {
    if (state.gameIdx >= state.gameWords.length) {
        endGame('rocket');
        return;
    }
    
    const word = state.gameWords[state.gameIdx];
    document.getElementById('rocketWord').textContent = word.word;
    
    // ç”Ÿæˆé€‰é¡¹
    let choices = [{ chinese: word.chinese, correct: true }];
    const others = vocab.filter(w => w.word !== word.word);
    const shuffled = shuffleArray([...others]);
    for (let i = 0; i < 3; i++) {
        choices.push({ chinese: shuffled[i].chinese, correct: false });
    }
    choices = shuffleArray(choices);
    
    document.getElementById('rocketOptions').innerHTML = choices.map((c, i) => `
        <div class="rocket-option" onclick="selectRocketOption(${i}, ${c.correct})">${c.chinese}</div>
    `).join('');
}

function selectRocketOption(idx, isCorrect) {
    const options = document.querySelectorAll('.rocket-option');
    options.forEach((opt, i) => {
        opt.style.pointerEvents = 'none';
        if (i === idx) {
            opt.classList.add(isCorrect ? 'correct' : 'wrong');
        }
    });
    
    if (isCorrect) {
        state.gameScore += 15;
        state.rocketAltitude += 20;
        state.gameCombo++;
        
        // ç«ç®­ä¸Šå‡
        const rocket = document.getElementById('rocket');
        rocket.classList.add('boost');
        
        const maxBottom = 280;
        const newBottom = Math.min(60 + state.rocketAltitude, maxBottom);
        rocket.style.bottom = newBottom + 'px';
        document.getElementById('rocketProgress').style.height = (state.rocketAltitude / 100 * 100) + '%';
        document.getElementById('altitude').textContent = state.rocketAltitude * 50;
        
        setTimeout(() => rocket.classList.remove('boost'), 500);
        
        playDictationWordByWord(state.gameWords[state.gameIdx]);
    } else {
        state.gameCombo = 0;
        // ç«ç®­ä¸‹é™ä¸€ç‚¹
        state.rocketAltitude = Math.max(0, state.rocketAltitude - 5);
        const rocket = document.getElementById('rocket');
        const newBottom = Math.max(60, 60 + state.rocketAltitude);
        rocket.style.bottom = newBottom + 'px';
        document.getElementById('rocketProgress').style.height = (state.rocketAltitude / 100 * 100) + '%';
        document.getElementById('altitude').textContent = state.rocketAltitude * 50;
    }
    
    document.getElementById('rocketScore').textContent = state.gameScore;
    
    setTimeout(() => {
        state.gameIdx++;
        showNextRocketQuestion();
    }, 800);
}

// ========== é…å¯¹æ¶ˆæ¶ˆä¹æ¸¸æˆ ==========

function startMatchGame() {
    // é€‰8ä¸ªå•è¯ï¼Œç”Ÿæˆ16å¼ å¡ç‰‡
    const words = state.gameWords.slice(0, 8);
    let cards = [];
    words.forEach((w, i) => {
        cards.push({ id: i, type: 'en', content: w.word, pairId: i });
        cards.push({ id: i + 100, type: 'cn', content: w.chinese, pairId: i });
    });
    cards = shuffleArray(cards);
    state.matchCards = cards;
    state.matchFlipped = [];
    state.matchPairs = 0;
    state.matchMoves = 0;
    state.matchStartTime = Date.now();
    
    const area = document.getElementById('gameArea');
    area.innerHTML = `
        <div class="card">
            <div class="game-header">
                <button class="game-back" onclick="backToGameMenu()">â†</button>
                <span class="game-title">ğŸ§© é…å¯¹æ¶ˆæ¶ˆä¹</span>
                <div class="game-stats">
                    <div class="game-stat"><span class="game-stat-icon">ğŸ¯</span><span id="matchPairs">0</span>/8</div>
                </div>
            </div>
            
            <div class="match-timer" id="matchTimer">00:00</div>
            
            <div class="match-arena">
                <div class="match-grid" id="matchGrid">
                    ${cards.map((c, i) => `
                        <div class="match-card" data-index="${i}" onclick="flipCard(${i})">
                            <div class="match-card-front">â“</div>
                            <div class="match-card-back">${c.content}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    // å¼€å§‹è®¡æ—¶
    state.gameTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - state.matchStartTime) / 1000);
        const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const secs = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('matchTimer').textContent = `${mins}:${secs}`;
    }, 1000);
}

function flipCard(index) {
    const card = document.querySelector(`.match-card[data-index="${index}"]`);
    if (card.classList.contains('flipped') || card.classList.contains('matched')) return;
    if (state.matchFlipped.length >= 2) return;
    
    card.classList.add('flipped');
    state.matchFlipped.push(index);
    
    if (state.matchFlipped.length === 2) {
        state.matchMoves++;
        const [first, second] = state.matchFlipped;
        const card1 = state.matchCards[first];
        const card2 = state.matchCards[second];
        
        if (card1.pairId === card2.pairId && card1.type !== card2.type) {
            // é…å¯¹æˆåŠŸ
            setTimeout(() => {
                document.querySelector(`.match-card[data-index="${first}"]`).classList.add('matched');
                document.querySelector(`.match-card[data-index="${second}"]`).classList.add('matched');
                state.matchFlipped = [];
                state.matchPairs++;
                state.gameScore += 20;
                document.getElementById('matchPairs').textContent = state.matchPairs;
                
                // æ’­æ”¾å•è¯å‘éŸ³
                const word = state.gameWords.find(w => w.word === (card1.type === 'en' ? card1.content : card2.content));
                if (word) playDictationWordByWord(word);
                
                if (state.matchPairs >= 8) {
                    clearInterval(state.gameTimer);
                    // æ ¹æ®æ—¶é—´åŠ åˆ†
                    const elapsed = Math.floor((Date.now() - state.matchStartTime) / 1000);
                    state.gameScore += Math.max(0, 100 - elapsed);
                    setTimeout(() => endGame('match'), 500);
                }
            }, 300);
        } else {
            // é…å¯¹å¤±è´¥
            setTimeout(() => {
                document.querySelector(`.match-card[data-index="${first}"]`).classList.remove('flipped');
                document.querySelector(`.match-card[data-index="${second}"]`).classList.remove('flipped');
                state.matchFlipped = [];
            }, 800);
        }
    }
}

// ========== æ¸¸æˆç»“æŸ ==========

function endGame(gameType) {
    if (state.gameTimer) {
        clearInterval(state.gameTimer);
        state.gameTimer = null;
    }
    
    const u = allUsers[currentUser];
    const earnedCoins = Math.floor(state.gameScore / 10);
    u.coins = (u.coins || 0) + earnedCoins;
    
    // æ›´æ–°æœ€é«˜åˆ†
    if (!u.highScores) u.highScores = {};
    const isNewRecord = !u.highScores[gameType] || state.gameScore > u.highScores[gameType];
    if (isNewRecord) u.highScores[gameType] = state.gameScore;
    
    saveUsers();
    
    const titles = {
        monster: 'ğŸ‘¾ æ€ªå…½å…¥ä¾µ',
        spelling: 'ğŸ”¤ å­—æ¯è‹±é›„',
        rocket: 'ğŸš€ å•è¯ç«ç®­',
        match: 'ğŸ§© é…å¯¹æ¶ˆæ¶ˆä¹'
    };
    
    const area = document.getElementById('gameArea');
    area.innerHTML = `
        <div class="card game-over">
            <div class="game-over-icon">${state.gameScore > 50 ? 'ğŸ‰' : 'ğŸ˜Š'}</div>
            <div class="game-over-title">${titles[gameType]}</div>
            ${isNewRecord ? '<div class="high-score">ğŸ† æ–°çºªå½•ï¼</div>' : ''}
            <div class="game-over-score">${state.gameScore}</div>
            <div class="game-over-detail">å®Œæˆ ${state.gameIdx}/${state.gameWords.length} ä¸ªå•è¯</div>
            <div class="game-over-coins">ğŸ’ +${earnedCoins} é‡‘å¸</div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="backToGameMenu()">è¿”å›èœå•</button>
                <button class="btn btn-primary" onclick="selectGame('${gameType}')">å†æ¥ä¸€æ¬¡</button>
            </div>
        </div>
    `;
}

init();
</script>
</body>
</html>
